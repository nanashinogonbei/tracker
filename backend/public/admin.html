<!DOCTYPE html>
<html lang="ja">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ - Webãƒˆãƒ©ãƒƒã‚«ãƒ¼</title>
	<link href="https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50">
	<div class="min-h-screen flex">
		<aside class="w-64 bg-white min-h-screen border-r">
			<div class="p-6">
				<div class="mt-4 space-y-1">
					<div class="px-4 py-2 text-sm">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†</div>
					<div class="px-4 py-2 text-sm text-gray-500"><a href="./account_index.html">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç®¡ç†</a></div>
					<div class="px-4 py-2 text-sm"><a href="#" id="logout-btn" class="text-red-600 hover:text-red-800">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>
				</div>
			</div>
		</aside>

		<main class="flex-1 p-8">
			<h1 class="text-2xl font-bold mb-8">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§</h1>
			<div id="projects-list" class="space-y-4 mb-8"></div>
			<button id="create-btn" class="bg-blue-500 text-white px-6 py-3 rounded hover:bg-blue-600">
				æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
			</button>
		</main>
	</div>

	<script src="/js/auth.js"></script>
	<script>
		const API_URL = '/api';

		async function loadProjects() {
			try {
				const res = await authFetch(`${API_URL}/projects`);
				const projects = await res.json();
				
				const list = document.getElementById('projects-list');
				list.innerHTML = projects.map(project => `
					<div class="bg-white rounded-lg shadow p-6 flex items-start gap-6">
						<div class="w-32 h-24 bg-gray-300 rounded flex-shrink-0"></div>
						
						<div class="flex-1">
							<h3 class="font-bold text-lg mb-1">${project.name}</h3>
							<p class="text-sm text-gray-600 mb-3">${project.url}</p>
							<div class="flex gap-4">
								<a href="test_index.html?id=${project._id}" class="text-blue-500 text-sm hover:underline">ABãƒ†ã‚¹ãƒˆ</a>
								<a href="analytics.html?id=${project._id}" class="text-blue-500 text-sm hover:underline">ã‚¢ã‚¯ã‚»ã‚¹è§£æ</a>
								<a href="#" data-project-id="${project._id}" class="delete-link text-red-500 text-sm hover:underline">å‰Šé™¤</a>
							</div>
						</div>

						<div class="flex-shrink-0">
							<div class="text-sm font-medium mb-2">SDK</div>
							<div class="bg-gray-50 p-3 rounded text-xs font-mono mb-2 max-w-md break-all">
								&lt;script src="${window.location.origin}/tracker/${project._id}.js" charset="utf-8" crossorigin="anonymous"&gt;&lt;/script&gt;
							</div>
							<button data-project-id="${project._id}" class="copy-btn w-full bg-blue-500 text-white px-4 py-2 rounded text-sm hover:bg-blue-600 mb-2">
								<span>ğŸ“‹ ã‚³ãƒ”ãƒ¼ã™ã‚‹</span>
							</button>
							<div class="text-xs text-gray-500 mt-2">
								<div class="font-medium mb-1">API Key:</div>
								<div class="bg-gray-100 p-2 rounded font-mono break-all">${project.apiKey}</div>
							</div>
						</div>
					</div>
				`).join('');
			} catch (err) {
				console.error('Failed to load projects:', err);
				if (err.message === 'Authentication required' || err.message === 'Session expired') {
					return; // authFetchãŒæ—¢ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå‡¦ç†æ¸ˆã¿
				}
				alert('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
			}
		}

		function copyCode(projectId, buttonElement) {
			const serverUrl = window.location.origin;
			const code = `<script src="${serverUrl}/tracker/${projectId}.js" charset="utf-8" crossorigin="anonymous"><\/script>`;
			navigator.clipboard.writeText(code);
			
			const span = buttonElement.querySelector('span');
			span.textContent = 'âœ“ ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ';
			setTimeout(() => {
				span.textContent = 'ğŸ“‹ ã‚³ãƒ”ãƒ¼ã™ã‚‹';
			}, 2000);
		}

		async function deleteProject(projectId) {
			if (!confirm('ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\né–¢é€£ã™ã‚‹ã™ã¹ã¦ã®ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ã€‚')) {
				return;
			}

			try {
				const res = await authFetch(`${API_URL}/projects/${projectId}`, {
					method: 'DELETE'
				});
				
				if (res.ok) {
					alert('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
					loadProjects();
				} else {
					alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
				}
			} catch (err) {
				console.error('Failed to delete project:', err);
				alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
			}
		}

		async function createProject() {
			const name = prompt('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
			const url = prompt('URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹: https://example.comï¼‰');
			if (!name || !url) return;

			try {
				await authFetch(`${API_URL}/projects`, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ name, url })
				});
				loadProjects();
			} catch (err) {
				console.error('Failed to create project:', err);
			}
		}

		// ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
		document.getElementById('create-btn').addEventListener('click', createProject);
		
		// delegationã§ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³ã¨å‰Šé™¤ãƒªãƒ³ã‚¯ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‡¦ç†
		document.getElementById('projects-list').addEventListener('click', (e) => {
			const copyBtn = e.target.closest('.copy-btn');
			if (copyBtn) {
				copyCode(copyBtn.dataset.projectId, copyBtn);
				return;
			}

			const deleteLink = e.target.closest('.delete-link');
			if (deleteLink) {
				e.preventDefault();
				deleteProject(deleteLink.dataset.projectId);
				return;
			}
		});

		// ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
		document.getElementById('logout-btn').addEventListener('click', (e) => {
			e.preventDefault();
			if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
				logout();
			}
		});

		// ãƒšãƒ¼ã‚¸åˆæœŸåŒ–
		(async () => {
			// èªè¨¼ãƒã‚§ãƒƒã‚¯
			const authenticated = await requireAuth();
			if (authenticated) {
				loadProjects();
			}
		})();
	</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>アクセス解析 - Webトラッカー</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f9fafb; }
    .container { display: flex; min-height: 100vh; }
    .sidebar { width: 256px; background: white; border-right: 1px solid #e5e7eb; padding: 24px; }
    .sidebar a { display: block; width: 100%; padding: 8px 16px; border: 1px solid #d1d5db; border-radius: 4px; text-align: center; text-decoration: none; color: #374151; font-size: 14px; margin-bottom: 8px; }
    .sidebar a:hover { background: #f9fafb; }
    .sidebar-menu { margin-top: 16px; }
    .sidebar-item { padding: 8px 16px; font-size: 14px; color: #6b7280; }
    .main { flex: 1; padding: 32px; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px; }
    .header h1 { font-size: 24px; font-weight: bold; }
    .header p { font-size: 14px; color: #6b7280; }
    .header a { color: #3b82f6; font-size: 14px; text-decoration: none; }
    .section { margin-bottom: 24px; }
    .section-title { font-size: 14px; font-weight: 500; margin-bottom: 8px; }
    .date-range { display: flex; align-items: center; gap: 16px; }
    .date-range input { padding: 8px 16px; border: 1px solid #d1d5db; border-radius: 4px; }
    .filters { display: flex; gap: 12px; margin-top: 12px; flex-wrap: wrap; }
    .filter { position: relative; }
    .filter-btn { padding: 8px 24px; border: 1px solid #d1d5db; border-radius: 9999px; background: white; cursor: pointer; font-size: 14px; }
    .filter-btn.active { background: #22c55e; color: white; border-color: #22c55e; }
    .filter-dropdown { display: none; position: absolute; top: 100%; left: 0; margin-top: 8px; background: white; border: 1px solid #d1d5db; border-radius: 8px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); padding: 16px; min-width: 240px; z-index: 10; max-height: 400px; overflow-y: auto; }
    .filter-dropdown.show { display: block; }
    .filter-search { width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 4px; margin-bottom: 12px; font-size: 14px; }
    .filter-search:focus { outline: none; border-color: #3b82f6; }
    .filter-option { display: flex; align-items: center; gap: 8px; padding: 8px 0; cursor: pointer; }
    .filter-option:hover { background: #f9fafb; }
    .filter-option input { cursor: pointer; }
    .filter-option.hidden { display: none; }
    .filter-close { width: 100%; margin-top: 8px; padding: 8px 16px; background: #e5e7eb; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; }
    .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; margin-bottom: 32px; }
    .stat-card { background: #f3f4f6; border-radius: 8px; padding: 24px; }
    .stat-card.white { background: white; border: 1px solid #e5e7eb; }
    .stat-label { font-size: 14px; color: #6b7280; margin-bottom: 8px; }
    .stat-value { font-size: 36px; font-weight: bold; }
    .popular-page { display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 8px; }
    .popular-page span:first-child { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-right: 8px; }
    .popular-page span:last-child { font-weight: 500; }
    .events-card { background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 24px; }
    .event-row { display: flex; align-items: start; gap: 24px; margin-bottom: 16px; }
    .event-row select { padding: 8px 16px; border: 1px solid #d1d5db; border-radius: 4px; min-width: 200px; }
    .event-row button { padding: 8px 16px; color: #ef4444; background: none; border: none; cursor: pointer; }
    .event-row button:hover { color: #dc2626; }
    .event-count { font-size: 48px; font-weight: bold; flex: 1; }
    .add-btn { width: 48px; height: 48px; background: #3b82f6; color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 24px; margin-top: 16px; }
    .add-btn:hover { background: #2563eb; }
  </style>
</head>
<body>
  <div class="container">
    <aside class="sidebar">
      <a href="admin.html">プロジェクト一覧</a>
      <div class="sidebar-menu">
        <div class="sidebar-item">プロジェクト管理</div>
        <div class="sidebar-item">アカウント管理</div>
      </div>
    </aside>

    <main class="main">
      <div class="header">
        <div>
          <h1 id="project-name">読み込み中...</h1>
          <p id="project-url"></p>
        </div>
        <a href="admin.html">戻る</a>
      </div>

      <div class="section">
        <div class="section-title">期間</div>
        <div class="date-range">
          <input type="date" id="start-date">
          <span>〜</span>
          <input type="date" id="end-date">
        </div>
      </div>

      <div class="section">
        <div class="section-title">フィルター</div>
        <div class="filters" id="filters"></div>
      </div>

      <div class="stats">
        <div class="stat-card">
          <div class="stat-label">ユニークユーザー</div>
          <div class="stat-value" id="unique-users">-</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">ページビュー</div>
          <div class="stat-value" id="page-views">-</div>
        </div>
        <div class="stat-card white">
          <div class="stat-label">人気ページ</div>
          <div id="popular-pages"></div>
        </div>
      </div>

      <div class="events-card">
        <div class="section-title">イベント</div>
        <div id="event-rows"></div>
        <button class="add-btn" id="add-event-btn">+</button>
      </div>
    </main>
  </div>

  <script>
    const API_URL = '/api';
    const projectId = new URLSearchParams(location.search).get('id');
    
    let project = null;
    let analyticsData = null;
    let suggestionData = null;
    let selectedFilters = { device: [], browser: [], os: [], language: ['ja'] };
    let eventRows = [];

    async function loadProject() {
      const res = await fetch(`${API_URL}/projects`);
      const projects = await res.json();
      project = projects.find(p => p._id === projectId);
      
      document.getElementById('project-name').textContent = project.name;
      document.getElementById('project-url').textContent = project.url;
    }

    async function loadSuggestions() {
      const res = await fetch(`${API_URL}/suggestions`);
      suggestionData = await res.json();
    }

    async function loadAnalytics(keepDropdownOpen = false) {
      const startDate = document.getElementById('start-date').value;
      const endDate = document.getElementById('end-date').value;
      
      const params = new URLSearchParams({ start: startDate, end: endDate });
      Object.entries(selectedFilters).forEach(([key, values]) => {
        if (values.length > 0) params.set(key, values.join(','));
      });

      const res = await fetch(`${API_URL}/analytics/${projectId}?${params}`);
      analyticsData = await res.json();
      
      document.getElementById('unique-users').textContent = analyticsData.uniqueUsers;
      document.getElementById('page-views').textContent = analyticsData.pageViews.toLocaleString();
      
      document.getElementById('popular-pages').innerHTML = analyticsData.popularPages
        .slice(0, 3)
        .map((page, idx) => `
          <div class="popular-page">
            <span>${idx + 1}. ${page.url}</span>
            <span>${page.count}view</span>
          </div>
        `).join('');

      if (keepDropdownOpen) {
        updateFilterButtons();
      } else {
        renderFilters();
      }
      
      eventRows.forEach((_, idx) => loadEventCount(idx));
    }
    
    function updateFilterButtons() {
      document.querySelectorAll('.filter').forEach(filterDiv => {
        const btn = filterDiv.querySelector('.filter-btn');
        const dropdown = filterDiv.querySelector('.filter-dropdown');
        const key = dropdown.dataset.filterKey;
        const hasSelected = selectedFilters[key].length > 0;
        
        btn.className = 'filter-btn' + (hasSelected ? ' active' : '');
        const labels = { device: 'デバイス', browser: 'ブラウザ', os: 'OS', language: '言語' };
        btn.textContent = labels[key] + (hasSelected ? ' ✓' : '');
      });
    }

    function renderFilters() {
      const filtersContainer = document.getElementById('filters');
      
      // 既存のドロップダウンの表示状態を保存
      const openDropdowns = [];
      document.querySelectorAll('.filter-dropdown.show').forEach(dd => {
        openDropdowns.push(dd.dataset.filterKey);
      });
      
      filtersContainer.innerHTML = '';
      
      [
        { label: 'デバイス', key: 'device', options: suggestionData.devices },
        { label: 'ブラウザ', key: 'browser', options: suggestionData.browsers },
        { label: 'OS', key: 'os', options: suggestionData.oss },
        { label: '言語', key: 'language', options: suggestionData.languages }
      ].forEach(filter => {
        const filterDiv = document.createElement('div');
        filterDiv.className = 'filter';
        
        const hasSelected = selectedFilters[filter.key].length > 0;
        
        const btn = document.createElement('button');
        btn.className = 'filter-btn' + (hasSelected ? ' active' : '');
        btn.textContent = filter.label + (hasSelected ? ' ✓' : '');
        btn.onclick = () => toggleFilter(filter.key);
        
        const dropdown = document.createElement('div');
        dropdown.className = 'filter-dropdown';
        dropdown.dataset.filterKey = filter.key;
        
        // 以前開いていた場合は再度開く
        if (openDropdowns.includes(filter.key)) {
          dropdown.classList.add('show');
        }
        
        // 検索ボックスを追加
        const searchInput = document.createElement('input');
        searchInput.type = 'text';
        searchInput.className = 'filter-search';
        searchInput.placeholder = `${filter.label}を検索...`;
        searchInput.onclick = (e) => e.stopPropagation();
        searchInput.oninput = (e) => filterOptions(filter.key, e.target.value);
        dropdown.appendChild(searchInput);
        
        filter.options.forEach(opt => {
          const label = document.createElement('label');
          label.className = 'filter-option';
          label.dataset.value = opt.toLowerCase();
          
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.value = opt;
          checkbox.checked = selectedFilters[filter.key].includes(opt);
          checkbox.onchange = (e) => {
            e.stopPropagation();
            updateFilter(filter.key, opt, checkbox.checked);
          };
          
          const span = document.createElement('span');
          span.textContent = opt;
          span.style.fontSize = '14px';
          
          label.appendChild(checkbox);
          label.appendChild(span);
          dropdown.appendChild(label);
        });
        
        const closeBtn = document.createElement('button');
        closeBtn.className = 'filter-close';
        closeBtn.textContent = '閉じる';
        closeBtn.onclick = () => closeFilter(filter.key);
        dropdown.appendChild(closeBtn);
        
        filterDiv.appendChild(btn);
        filterDiv.appendChild(dropdown);
        filtersContainer.appendChild(filterDiv);
      });
    }

    function filterOptions(key, searchText) {
      const dropdown = document.querySelector(`.filter-dropdown[data-filter-key="${key}"]`);
      const options = dropdown.querySelectorAll('.filter-option');
      const search = searchText.toLowerCase();
      
      options.forEach(option => {
        const value = option.dataset.value;
        if (value.includes(search)) {
          option.classList.remove('hidden');
        } else {
          option.classList.add('hidden');
        }
      });
    }

    function toggleFilter(key) {
      const dropdown = document.querySelector(`.filter-dropdown[data-filter-key="${key}"]`);
      dropdown.classList.toggle('show');
      
      // ドロップダウンを開いたときに検索ボックスをクリア
      if (dropdown.classList.contains('show')) {
        const searchInput = dropdown.querySelector('.filter-search');
        searchInput.value = '';
        filterOptions(key, '');
      }
    }

    function closeFilter(key) {
      document.querySelector(`.filter-dropdown[data-filter-key="${key}"]`).classList.remove('show');
    }

    function updateFilter(key, value, checked) {
      if (checked) {
        selectedFilters[key].push(value);
      } else {
        selectedFilters[key] = selectedFilters[key].filter(v => v !== value);
      }
      loadAnalytics(true);
    }

    function addEventRow() {
      eventRows.push({ event: '', count: null });
      renderEventRows();
    }

    function removeEventRow(idx) {
      eventRows.splice(idx, 1);
      renderEventRows();
    }

    function renderEventRows() {
      const container = document.getElementById('event-rows');
      container.innerHTML = '';
      
      eventRows.forEach((row, idx) => {
        const rowDiv = document.createElement('div');
        rowDiv.className = 'event-row';
        
        const select = document.createElement('select');
        select.id = `event-select-${idx}`;
        
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = 'イベントを選択 ▼';
        select.appendChild(defaultOption);
        
        if (analyticsData) {
          analyticsData.availableEvents.forEach(e => {
            const option = document.createElement('option');
            option.value = e;
            option.textContent = e;
            option.selected = row.event === e;
            select.appendChild(option);
          });
        }
        
        select.onchange = () => loadEventCount(idx);
        
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = '削除';
        deleteBtn.onclick = () => removeEventRow(idx);
        
        const countDiv = document.createElement('div');
        countDiv.className = 'event-count';
        countDiv.id = `event-count-${idx}`;
        countDiv.textContent = row.count !== null ? row.count : '';
        
        rowDiv.appendChild(select);
        rowDiv.appendChild(deleteBtn);
        rowDiv.appendChild(countDiv);
        container.appendChild(rowDiv);
      });
    }

    async function loadEventCount(rowId) {
      const selectEl = document.getElementById(`event-select-${rowId}`);
      const event = selectEl.value;
      eventRows[rowId].event = event;
      
      if (!event) {
        eventRows[rowId].count = null;
        document.getElementById(`event-count-${rowId}`).textContent = '';
        return;
      }

      const startDate = document.getElementById('start-date').value;
      const endDate = document.getElementById('end-date').value;
      const params = new URLSearchParams({ start: startDate, end: endDate, event });

      const res = await fetch(`${API_URL}/analytics/${projectId}/event-count?${params}`);
      const data = await res.json();
      eventRows[rowId].count = data.count;
      document.getElementById(`event-count-${rowId}`).textContent = data.count;
    }

    function getJSTDateString(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function initDates() {
      const now = new Date();
      const jstNow = new Date(now.getTime() + (9 * 60 * 60 * 1000));
      const jstStart = new Date(jstNow.getTime() - (30 * 24 * 60 * 60 * 1000));
      
      document.getElementById('start-date').value = getJSTDateString(jstStart);
      document.getElementById('end-date').value = getJSTDateString(jstNow);
    }

    async function init() {
      initDates();
      await loadProject();
      await loadSuggestions();
      await loadAnalytics();
    }

    init();

    document.getElementById('start-date').addEventListener('change', loadAnalytics);
    document.getElementById('end-date').addEventListener('change', loadAnalytics);
    document.getElementById('add-event-btn').addEventListener('click', addEventRow);
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>アクセス解析 - Webトラッカー</title>
  <link href="https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50">
  <div class="min-h-screen flex">
    <aside class="w-64 bg-white min-h-screen border-r">
      <div class="p-6">
        <div class="mt-4 space-y-1">
          <div class="px-4 py-2 text-sm"><a href="./admin.html">プロジェクト管理</a></div>
          <div class="px-4 py-2 text-sm text-gray-500"><a href="./account_index.html">アカウント管理</a></div>
          <div class="px-4 py-2 text-sm"><a href="#" id="logout-btn" class="text-red-600 hover:text-red-800">ログアウト</a></div>
        </div>
      </div>
    </aside>

    <main class="flex-1 p-8">
      <div class="flex justify-between items-center mb-8">
        <div>
          <h1 id="project-name" class="text-2xl font-bold">読み込み中...</h1>
          <p id="project-url" class="text-sm text-gray-600"></p>
        </div>
        <a href="admin.html" class="text-blue-500 text-sm hover:underline">戻る</a>
      </div>

      <div class="bg-white rounded-lg shadow p-6 mb-6">
        <div class="text-sm font-medium text-gray-700 mb-3">期間</div>
        <div class="flex items-center gap-3">
          <input type="date" id="start-date" class="px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          <span class="text-gray-500">〜</span>
          <input type="date" id="end-date" class="px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
      </div>

      <div class="bg-white rounded-lg shadow p-6 mb-6">
        <div class="text-sm font-medium text-gray-700 mb-3">フィルター</div>
        <div class="flex flex-wrap gap-3" id="filters"></div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
        <div class="bg-white rounded-lg shadow p-6">
          <div class="text-sm font-medium text-gray-500 mb-2">ユニークユーザー</div>
          <div class="text-3xl font-bold text-gray-900" id="unique-users">-</div>
        </div>
        <div class="bg-white rounded-lg shadow p-6">
          <div class="text-sm font-medium text-gray-500 mb-2">ページビュー</div>
          <div class="text-3xl font-bold text-gray-900" id="page-views">-</div>
        </div>
        <div class="bg-white rounded-lg shadow p-6">
          <div class="text-sm font-medium text-gray-500 mb-2">人気ページ</div>
          <div id="popular-pages" class="space-y-2 text-sm"></div>
        </div>
      </div>

      <div class="bg-white rounded-lg shadow p-6">
        <div class="flex justify-between items-center mb-4">
          <div class="text-sm font-medium text-gray-700">イベント</div>
          <button id="add-event-btn" class="w-8 h-8 flex items-center justify-center bg-blue-500 text-white rounded-full hover:bg-blue-600 text-xl">+</button>
        </div>
        <div id="event-rows" class="space-y-3"></div>
      </div>
    </main>
  </div>

  <script src="/js/auth.js"></script>
  <script>
    const API_URL = '/api';
    const projectId = new URLSearchParams(location.search).get('id');
    
    let project = null;
    let analyticsData = null;
    let suggestionData = null;
    let selectedFilters = { device: [], browser: [], os: [], language: ['ja'] };
    let eventRows = [];

    async function loadProject() {
      try {
        const res = await authFetch(`${API_URL}/projects`);
        const projects = await res.json();
        project = projects.find(p => p._id === projectId);
        
        document.getElementById('project-name').textContent = project.name;
        document.getElementById('project-url').textContent = project.url;
			} catch (err) {
				console.error('Failed to load projects:', err);
				if (err.message === 'Authentication required' || err.message === 'Session expired') {
					return;
				}
				alert('プロジェクトの読み込みに失敗しました');
			}
    }

    async function loadSuggestions() {
      try {
        const res = await authFetch(`${API_URL}/analytics/suggestions`);
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        suggestionData = await res.json();
        console.log('Suggestions loaded:', suggestionData);
      } catch (err) {
        console.error('Failed to load suggestions:', err);
        suggestionData = { devices: [], browsers: [], oss: [], languages: [] };
      }
    }

    async function loadAnalytics(keepDropdownOpen = false) {
      try {
        const startDate = document.getElementById('start-date').value;
        const endDate = document.getElementById('end-date').value;
        
        const params = new URLSearchParams({ start: startDate, end: endDate });
        Object.entries(selectedFilters).forEach(([key, values]) => {
          if (values.length > 0) params.set(key, values.join(','));
        });

        const res = await authFetch(`${API_URL}/analytics/${projectId}?${params}`);
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        analyticsData = await res.json();
        
        document.getElementById('unique-users').textContent = analyticsData.uniqueUsers;
        document.getElementById('page-views').textContent = analyticsData.pageViews.toLocaleString();
        
        document.getElementById('popular-pages').innerHTML = analyticsData.popularPages
          .slice(0, 3)
          .map((page, idx) => `
            <div class="flex justify-between items-center">
              <span class="text-gray-700">${idx + 1}. ${page.url}</span>
              <span class="text-gray-500">${page.count}view</span>
            </div>
          `).join('');

        if (keepDropdownOpen) {
          updateFilterButtons();
        } else {
          renderFilters();
        }
        
        eventRows.forEach((_, idx) => loadEventCount(idx));
			} catch (err) {
				console.error('Failed to load analytics:', err);
				if (err.message === 'Authentication required' || err.message === 'Session expired') {
					return;
				}
				alert('プロジェクトの読み込みに失敗しました');
			}
    }
    
    function updateFilterButtons() {
      document.querySelectorAll('[data-filter-key]').forEach(btn => {
        const key = btn.dataset.filterKey;
        const hasSelected = selectedFilters[key].length > 0;
        
        btn.className = hasSelected 
          ? 'px-4 py-2 bg-blue-500 text-white rounded-md text-sm hover:bg-blue-600'
          : 'px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-md text-sm hover:bg-gray-50';
        
        const labels = { device: 'デバイス', browser: 'ブラウザ', os: 'OS', language: '言語' };
        btn.textContent = labels[key] + (hasSelected ? ' ✓' : '');
      });
    }

    function renderFilters() {
      const filtersContainer = document.getElementById('filters');
      
      const openDropdowns = [];
      document.querySelectorAll('.dropdown-content').forEach(dd => {
        if (!dd.classList.contains('hidden')) {
          openDropdowns.push(dd.dataset.filterKey);
        }
      });
      
      filtersContainer.innerHTML = '';
      
      [
        { label: 'デバイス', key: 'device', options: suggestionData.devices },
        { label: 'ブラウザ', key: 'browser', options: suggestionData.browsers },
        { label: 'OS', key: 'os', options: suggestionData.oss },
        { label: '言語', key: 'language', options: suggestionData.languages }
      ].forEach(filter => {
        const hasSelected = selectedFilters[filter.key].length > 0;
        
        const filterDiv = document.createElement('div');
        filterDiv.className = 'relative';
        
        const btn = document.createElement('button');
        btn.dataset.filterKey = filter.key;
        btn.className = hasSelected 
          ? 'px-4 py-2 bg-blue-500 text-white rounded-md text-sm hover:bg-blue-600'
          : 'px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-md text-sm hover:bg-gray-50';
        btn.textContent = filter.label + (hasSelected ? ' ✓' : '');
        btn.onclick = () => toggleFilter(filter.key);
        
        const dropdown = document.createElement('div');
        dropdown.className = 'dropdown-content absolute left-0 mt-2 w-64 bg-white rounded-lg shadow-lg border border-gray-200 z-10 hidden';
        dropdown.dataset.filterKey = filter.key;
        
        if (openDropdowns.includes(filter.key)) {
          dropdown.classList.remove('hidden');
        }
        
        const searchInput = document.createElement('input');
        searchInput.type = 'text';
        searchInput.className = 'w-full px-3 py-2 border-b border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500';
        searchInput.placeholder = `${filter.label}を検索...`;
        searchInput.onclick = (e) => e.stopPropagation();
        searchInput.oninput = (e) => filterOptions(filter.key, e.target.value);
        dropdown.appendChild(searchInput);
        
        const optionsContainer = document.createElement('div');
        optionsContainer.className = 'max-h-48 overflow-y-auto p-2';
        
        filter.options.forEach(opt => {
          const label = document.createElement('label');
          label.className = 'flex items-center px-2 py-2 hover:bg-gray-50 rounded cursor-pointer';
          label.dataset.value = opt.toLowerCase();
          
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.value = opt;
          checkbox.checked = selectedFilters[filter.key].includes(opt);
          checkbox.className = 'w-4 h-4 text-blue-600 rounded mr-2';
          checkbox.onchange = (e) => {
            e.stopPropagation();
            updateFilter(filter.key, opt, checkbox.checked);
          };
          
          const span = document.createElement('span');
          span.textContent = opt;
          span.className = 'text-sm text-gray-700';
          
          label.appendChild(checkbox);
          label.appendChild(span);
          optionsContainer.appendChild(label);
        });
        
        dropdown.appendChild(optionsContainer);
        
        const closeBtn = document.createElement('button');
        closeBtn.className = 'w-full px-3 py-2 text-sm text-blue-600 hover:bg-gray-50 border-t border-gray-200';
        closeBtn.textContent = '閉じる';
        closeBtn.onclick = () => closeFilter(filter.key);
        dropdown.appendChild(closeBtn);
        
        filterDiv.appendChild(btn);
        filterDiv.appendChild(dropdown);
        filtersContainer.appendChild(filterDiv);
      });
    }

    function filterOptions(key, searchText) {
      const dropdown = document.querySelector(`.dropdown-content[data-filter-key="${key}"]`);
      const options = dropdown.querySelectorAll('label');
      const search = searchText.toLowerCase();
      
      options.forEach(option => {
        const value = option.dataset.value;
        if (value.includes(search)) {
          option.classList.remove('hidden');
        } else {
          option.classList.add('hidden');
        }
      });
    }

    function toggleFilter(key) {
      const dropdown = document.querySelector(`.dropdown-content[data-filter-key="${key}"]`);
      dropdown.classList.toggle('hidden');
      
      if (!dropdown.classList.contains('hidden')) {
        const searchInput = dropdown.querySelector('input[type="text"]');
        searchInput.value = '';
        filterOptions(key, '');
      }
    }

    function closeFilter(key) {
      document.querySelector(`.dropdown-content[data-filter-key="${key}"]`).classList.add('hidden');
    }

    function updateFilterValue(key, value, checked) {
      if (checked) {
        selectedFilters[key].push(value);
      } else {
        selectedFilters[key] = selectedFilters[key].filter(v => v !== value);
      }
      
      // ボタンの表示を更新
      const btn = document.querySelector(`[data-filter-key="${key}"]`);
      const hasSelected = selectedFilters[key].length > 0;
      const labels = { device: 'デバイス', browser: 'ブラウザ', os: 'OS', language: '言語' };
      
      btn.className = hasSelected 
        ? 'px-4 py-2 bg-blue-500 text-white rounded-md text-sm hover:bg-blue-600'
        : 'px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-md text-sm hover:bg-gray-50';
      btn.textContent = labels[key] + (hasSelected ? ' ✓' : '');
      
      // データを再読み込み
      loadAnalyticsData();
    }

    async function loadAnalyticsData() {
      try {
        const startDate = document.getElementById('start-date').value;
        const endDate = document.getElementById('end-date').value;
        
        const params = new URLSearchParams({ start: startDate, end: endDate });
        Object.entries(selectedFilters).forEach(([key, values]) => {
          if (values.length > 0) params.set(key, values.join(','));
        });

        const res = await authFetch(`${API_URL}/analytics/${projectId}?${params}`);
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        analyticsData = await res.json();
        
        document.getElementById('unique-users').textContent = analyticsData.uniqueUsers;
        document.getElementById('page-views').textContent = analyticsData.pageViews.toLocaleString();
        
        document.getElementById('popular-pages').innerHTML = analyticsData.popularPages
          .slice(0, 3)
          .map((page, idx) => `
            <div class="flex justify-between items-center">
              <span class="text-gray-700">${idx + 1}. ${page.url}</span>
              <span class="text-gray-500">${page.count}view</span>
            </div>
          `).join('');
        
        eventRows.forEach((_, idx) => loadEventCount(idx));
			} catch (err) {
				console.error('Failed to load analytics:', err);
				if (err.message === 'Authentication required' || err.message === 'Session expired') {
					return;
				}
				alert('アナリティクスの読み込みに失敗しました');
			}
    }

    function updateFilter(key, value, checked) {
      updateFilterValue(key, value, checked);
    }

    function addEventRow() {
      eventRows.push({ event: '', count: null });
      renderEventRows();
    }

    function removeEventRow(idx) {
      eventRows.splice(idx, 1);
      renderEventRows();
    }

    function renderEventRows() {
      const container = document.getElementById('event-rows');
      container.innerHTML = '';
      
      eventRows.forEach((row, idx) => {
        const rowDiv = document.createElement('div');
        rowDiv.className = 'flex items-center gap-3';
        
        const select = document.createElement('select');
        select.id = `event-select-${idx}`;
        select.className = 'flex-1 px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500';
        
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = 'イベントを選択 ▼';
        select.appendChild(defaultOption);
        
        if (analyticsData) {
          analyticsData.availableEvents.forEach(e => {
            const option = document.createElement('option');
            option.value = e;
            option.textContent = e;
            option.selected = row.event === e;
            select.appendChild(option);
          });
        }
        
        select.onchange = () => loadEventCount(idx);
        
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = '削除';
        deleteBtn.className = 'px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 text-sm';
        deleteBtn.onclick = () => removeEventRow(idx);
        
        const countDiv = document.createElement('div');
        countDiv.className = 'w-24 text-right font-medium text-gray-900';
        countDiv.id = `event-count-${idx}`;
        countDiv.textContent = row.count !== null ? row.count : '';
        
        rowDiv.appendChild(select);
        rowDiv.appendChild(deleteBtn);
        rowDiv.appendChild(countDiv);
        container.appendChild(rowDiv);
      });
    }

    async function loadEventCount(rowId) {
      try {
        const selectEl = document.getElementById(`event-select-${rowId}`);
        const event = selectEl.value;
        eventRows[rowId].event = event;
        
        if (!event) {
          eventRows[rowId].count = null;
          document.getElementById(`event-count-${rowId}`).textContent = '';
          return;
        }

        const startDate = document.getElementById('start-date').value;
        const endDate = document.getElementById('end-date').value;
        const params = new URLSearchParams({ start: startDate, end: endDate, event });

        const res = await authFetch(`${API_URL}/analytics/${projectId}/event-count?${params}`);
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        const data = await res.json();
        eventRows[rowId].count = data.count;
        document.getElementById(`event-count-${rowId}`).textContent = data.count;
      } catch (err) {
        console.error('Failed to load event count:', err);
      }
    }

    function getJSTDateString(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function initDates() {
      const now = new Date();
      const jstNow = new Date(now.getTime() + (9 * 60 * 60 * 1000));
      const jstStart = new Date(jstNow.getTime() - (30 * 24 * 60 * 60 * 1000));
      
      document.getElementById('start-date').value = getJSTDateString(jstStart);
      document.getElementById('end-date').value = getJSTDateString(jstNow);
    }

    // ログアウト処理
    document.getElementById('logout-btn').addEventListener('click', (e) => {
      e.preventDefault();
      if (confirm('ログアウトしますか？')) {
        logout();
      }
    });

    // ページ初期化
    (async () => {
      // 認証チェック
      const authenticated = await requireAuth();
      if (authenticated) {
        initDates();
        loadProject();
        loadSuggestions();
        loadAnalytics();
      }
    })();

    document.getElementById('start-date').addEventListener('change', loadAnalytics);
    document.getElementById('end-date').addEventListener('change', loadAnalytics);
    document.getElementById('add-event-btn').addEventListener('click', addEventRow);
  </script>
</body>
</html>
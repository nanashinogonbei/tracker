<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>プロジェクト編集 - Webトラッカー</title>
  <link href="https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50">
  <div class="min-h-screen flex">
    <aside class="w-64 bg-white min-h-screen border-r">
      <div class="p-6">
        <div class="mt-4 space-y-1">
          <div class="px-4 py-2 text-sm"><a href="./admin.html">プロジェクト管理</a></div>
          <div class="px-4 py-2 text-sm text-gray-500"><a href="./account_index.html">アカウント管理</a></div>
          <div class="px-4 py-2 text-sm"><a href="#" id="logout-btn" class="text-red-600 hover:text-red-800">ログアウト</a></div>
        </div>
      </div>
    </aside>

    <main class="flex-1 p-8 max-w-4xl">
      <div class="flex justify-between items-center mb-8">
        <h1 class="text-2xl font-bold">プロジェクト編集</h1>
        <a href="admin.html" class="text-blue-500 text-sm hover:underline">戻る</a>
      </div>

      <div class="bg-white rounded-lg shadow p-6 space-y-6">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">プロジェクト名</label>
          <input 
            type="text" 
            id="project-name" 
            class="w-full px-4 py-2 bg-gray-100 border border-gray-300 rounded-md"
            readonly
          >
          <p class="text-xs text-gray-500 mt-1">※プロジェクト名とURLは変更できません</p>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">URL</label>
          <input 
            type="text" 
            id="project-url" 
            class="w-full px-4 py-2 bg-gray-100 border border-gray-300 rounded-md"
            readonly
          >
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">API Key</label>
          <div class="flex items-center gap-2">
            <input 
              type="text" 
              id="api-key" 
              class="flex-1 px-4 py-2 bg-gray-100 border border-gray-300 rounded-md font-mono text-sm"
              readonly
            >
            <button 
              id="copy-api-key-btn"
              class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 text-sm"
            >
              コピー
            </button>
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            許可するオリジン（CORS設定）
          </label>
          <div class="space-y-2 mb-3">
            <div id="origins-list" class="space-y-2">
              <!-- 動的に追加される -->
            </div>
            <button 
              id="add-origin-btn"
              class="w-full px-4 py-2 border-2 border-dashed border-gray-300 rounded-md text-gray-600 hover:border-blue-500 hover:text-blue-500 text-sm"
            >
              + オリジンを追加
            </button>
          </div>
          <div class="text-xs text-gray-600 bg-blue-50 p-3 rounded space-y-1">
            <p class="font-semibold text-gray-700">設定例:</p>
            <p>• 通常: <code class="bg-white px-2 py-0.5 rounded border">https://example.com</code></p>
            <p>• ワイルドカード: <code class="bg-white px-2 py-0.5 rounded border">https://*.example.com</code></p>
            <p>• 開発環境: <code class="bg-white px-2 py-0.5 rounded border">http://localhost:3000</code></p>
            <p class="mt-2 text-gray-600">※空の場合、本番環境では全てのオリジンが拒否されます</p>
          </div>
        </div>

        <div class="flex justify-center pt-4">
          <button 
            id="save-btn" 
            class="bg-blue-500 text-white px-8 py-3 rounded-md hover:bg-blue-600 font-medium"
          >
            保存
          </button>
        </div>
      </div>
    </main>
  </div>

  <script src="/js/auth.js"></script>
  <script>
    const API_URL = '/api';
    const params = new URLSearchParams(location.search);
    const projectId = params.get('id');

    let origins = [];

    async function loadProject() {
      if (!projectId) {
        alert('プロジェクトIDが指定されていません');
        location.href = 'admin.html';
        return;
      }

      try {
        const res = await authFetch(`${API_URL}/projects`);
        const projects = await res.json();
        const project = projects.find(p => p._id === projectId);
        
        if (!project) {
          alert('プロジェクトが見つかりません');
          location.href = 'admin.html';
          return;
        }

        document.getElementById('project-name').value = project.name;
        document.getElementById('project-url').value = project.url;
        document.getElementById('api-key').value = project.apiKey;
        
        origins = project.allowedOrigins || [];
        renderOrigins();
      } catch (err) {
        console.error('Failed to load project:', err);
        if (err.message === 'Authentication required' || err.message === 'Session expired') {
          return;
        }
        alert('プロジェクトの読み込みに失敗しました');
      }
    }

    function renderOrigins() {
      const container = document.getElementById('origins-list');
      
      if (origins.length === 0) {
        container.innerHTML = '<div class="text-sm text-gray-500 italic py-2">オリジンが設定されていません</div>';
        return;
      }

      container.innerHTML = origins.map((origin, index) => `
        <div class="flex items-center gap-2">
          <input 
            type="text" 
            value="${origin}"
            data-index="${index}"
            class="origin-input flex-1 px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            placeholder="https://example.com"
          >
          <button 
            data-index="${index}"
            class="remove-origin-btn px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 text-sm"
          >
            削除
          </button>
        </div>
      `).join('');
    }

    function addOrigin() {
      origins.push('');
      renderOrigins();
      
      // 追加された入力欄にフォーカス
      const inputs = document.querySelectorAll('.origin-input');
      if (inputs.length > 0) {
        inputs[inputs.length - 1].focus();
      }
    }

    function removeOrigin(index) {
      origins.splice(index, 1);
      renderOrigins();
    }

    function updateOrigin(index, value) {
      origins[index] = value;
    }

    async function saveProject() {
      // 空の値を除外
      const filteredOrigins = origins
        .map(o => o.trim())
        .filter(o => o !== '');

      // バリデーション
      for (const origin of filteredOrigins) {
        // ワイルドカードパターンのチェック
        if (origin.match(/^https?:\/\/\*\..+/)) {
          const domain = origin.replace(/^https?:\/\/\*\./, '');
          if (!/^[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(domain)) {
            alert(`無効なワイルドカードパターンです: ${origin}\n例: https://*.example.com`);
            return;
          }
          continue;
        }

        // 通常のURLチェック
        try {
          const url = new URL(origin);
          if (!['http:', 'https:'].includes(url.protocol)) {
            alert(`無効なプロトコルです: ${origin}\nhttp:// または https:// を使用してください`);
            return;
          }
        } catch (e) {
          alert(`無効なURLです: ${origin}\n例: https://example.com`);
          return;
        }
      }

      try {
        console.log('[ProjectDetail] Sending allowedOrigins:', JSON.stringify(filteredOrigins));

        const res = await authFetch(`${API_URL}/projects/${projectId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ allowedOrigins: filteredOrigins })
        });

        if (res.ok) {
          const updated = await res.json();
          console.log('[ProjectDetail] Save response (updated project):', JSON.stringify(updated.allowedOrigins));
          alert('保存しました');
          location.href = 'admin.html';
        } else {
          const error = await res.json();
          console.error('[ProjectDetail] Save failed:', error);
          alert('保存に失敗しました: ' + (error.error || '不明なエラー'));
        }
      } catch (err) {
        console.error('Failed to save project:', err);
        alert('保存に失敗しました');
      }
    }

    // API Keyコピー
    document.getElementById('copy-api-key-btn').addEventListener('click', () => {
      const apiKey = document.getElementById('api-key').value;
      navigator.clipboard.writeText(apiKey);
      
      const btn = document.getElementById('copy-api-key-btn');
      btn.textContent = '✓ コピーしました';
      setTimeout(() => {
        btn.textContent = 'コピー';
      }, 2000);
    });

    // オリジン追加
    document.getElementById('add-origin-btn').addEventListener('click', addOrigin);

    // オリジン削除と入力変更（イベント委譲）
    document.getElementById('origins-list').addEventListener('click', (e) => {
      const removeBtn = e.target.closest('.remove-origin-btn');
      if (removeBtn) {
        const index = parseInt(removeBtn.dataset.index);
        removeOrigin(index);
      }
    });

    document.getElementById('origins-list').addEventListener('input', (e) => {
      if (e.target.classList.contains('origin-input')) {
        const index = parseInt(e.target.dataset.index);
        updateOrigin(index, e.target.value);
      }
    });

    // 保存
    document.getElementById('save-btn').addEventListener('click', saveProject);

    // ログアウト
    document.getElementById('logout-btn').addEventListener('click', (e) => {
      e.preventDefault();
      if (confirm('ログアウトしますか？')) {
        logout();
      }
    });

    // ページ初期化
    (async () => {
      const authenticated = await requireAuth();
      if (authenticated) {
        loadProject();
      }
    })();
  </script>
</body>
</html>
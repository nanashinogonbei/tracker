<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ABテスト詳細 - Webトラッカー</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f9fafb; }
    .container { display: flex; min-height: 100vh; }
    .sidebar { width: 176px; background: white; border-right: 1px solid #e5e7eb; padding: 24px; }
    .sidebar a { display: block; width: 100%; padding: 8px 16px; border: 1px solid #d1d5db; border-radius: 4px; text-align: center; text-decoration: none; color: #374151; font-size: 14px; margin-bottom: 8px; }
    .sidebar-item { padding: 8px 16px; font-size: 14px; color: #6b7280; }
    .main { flex: 1; padding: 32px; max-width: 1200px; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px; }
    .header-left { display: flex; align-items: center; gap: 16px; }
    .header-left input { font-size: 20px; font-weight: bold; border: none; background: transparent; padding: 4px; }
    .toggle-container { display: flex; align-items: center; gap: 12px; }
    .toggle-label { font-size: 14px; font-weight: 500; }
    .toggle-switch { position: relative; width: 56px; height: 32px; cursor: pointer; }
    .toggle-switch input { display: none; }
    .toggle-bg { position: absolute; inset: 0; background: #d1d5db; border-radius: 9999px; transition: background 0.3s; }
    .toggle-switch input:checked + .toggle-bg { background: #22c55e; }
    .toggle-handle { position: absolute; left: 4px; top: 4px; width: 24px; height: 24px; background: white; border-radius: 50%; transition: transform 0.3s; }
    .toggle-switch input:checked ~ .toggle-handle { transform: translateX(24px); }
    .section { background: #fffbeb; border-radius: 8px; padding: 24px; margin-bottom: 24px; }
    .section-title { font-size: 16px; font-weight: 500; margin-bottom: 16px; }
    .form-group { margin-bottom: 16px; }
    .form-label { display: block; font-size: 14px; margin-bottom: 8px; }
    .form-input, .form-textarea { width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 14px; }
    .form-textarea { min-height: 60px; resize: vertical; font-family: monospace; }
    .form-row { display: flex; gap: 16px; align-items: center; }
    .date-separator { padding: 8px; }
    .condition-group { margin-bottom: 16px; padding: 16px; background: white; border-radius: 8px; }
    .condition-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; cursor: pointer; }
    .condition-header::after { content: '▼'; transition: transform 0.3s; }
    .condition-header.collapsed::after { transform: rotate(-90deg); }
    .condition-content { display: none; }
    .condition-content.show { display: block; }
    .condition-row { display: flex; gap: 12px; margin-bottom: 12px; align-items: start; }
    .condition-row input { flex: 1; position: relative; }
    .condition-row select { min-width: 180px; }
    .condition-row textarea { flex: 1; min-height: 100px; }
    .suggest-input-wrapper { position: relative; flex: 1; }
    .suggest-dropdown { display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #d1d5db; border-radius: 4px; max-height: 200px; overflow-y: auto; z-index: 100; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
    .suggest-dropdown.show { display: block; }
    .suggest-option { padding: 8px 12px; cursor: pointer; font-size: 14px; }
    .suggest-option:hover { background: #f3f4f6; }
    .suggest-option.active { background: #e0e7ff; }
    .condition-footer { display: flex; justify-content: flex-end; margin-top: 12px; }
    .btn-add-condition { background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px; }
    .btn-add { background: #3b82f6; color: white; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .btn-remove { color: #ef4444; background: none; border: none; padding: 8px 16px; cursor: pointer; }
    .creative-section { background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 24px; margin-bottom: 24px; }
    .creative-row { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 1fr 1fr; gap: 16px; margin-bottom: 16px; padding: 16px; background: #f9fafb; border-radius: 8px; align-items: center; }
    .creative-col { display: flex; flex-direction: column; }
    .creative-col label { font-size: 12px; color: #6b7280; margin-bottom: 4px; }
    .creative-col input, .creative-col select { padding: 6px 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 14px; }
    .creative-stats { display: flex; flex-direction: column; }
    .creative-stats div { font-size: 12px; color: #6b7280; }
    .btn-code { background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 13px; white-space: nowrap; }
    .btn-save { background: #3b82f6; color: white; border: none; padding: 12px 32px; border-radius: 4px; cursor: pointer; font-size: 16px; }
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
    .modal.show { display: flex; }
    .modal-content { background: white; border-radius: 8px; padding: 32px; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; }
    .modal-header { font-size: 20px; font-weight: bold; margin-bottom: 24px; }
    .modal-section { margin-bottom: 24px; }
    .modal-section-title { font-size: 16px; font-weight: 500; margin-bottom: 12px; }
    .code-editor { width: 100%; min-height: 200px; padding: 12px; border: 1px solid #d1d5db; border-radius: 4px; font-family: 'Courier New', monospace; font-size: 13px; resize: vertical; }
    .modal-footer { display: flex; justify-content: center; gap: 16px; margin-top: 24px; }
    .btn-modal-save { background: #3b82f6; color: white; border: none; padding: 12px 48px; border-radius: 4px; cursor: pointer; font-size: 16px; }
    .btn-modal-cancel { background: #e5e7eb; border: none; padding: 12px 48px; border-radius: 4px; cursor: pointer; font-size: 16px; }
  </style>
</head>
<body>
  <div class="container">
    <aside class="sidebar">
      <a href="#" onclick="goBack(); return false;">プロジェクト管理</a>
      <div class="sidebar-item">アカウント管理</div>
    </aside>

    <main class="main">
      <div class="header">
        <div class="header-left">
          <input type="text" id="test-name" placeholder="テスト名を入力" value="">
          <div class="toggle-container">
            <span class="toggle-label" id="toggle-label">OFF</span>
            <label class="toggle-switch">
              <input type="checkbox" id="test-active">
              <span class="toggle-bg"></span>
              <span class="toggle-handle"></span>
            </label>
          </div>
        </div>
        <a href="#" onclick="goBack(); return false;" style="color: #3b82f6; font-size: 14px; text-decoration: none;">戻る</a>
      </div>

      <div class="section">
        <div class="form-group">
          <label class="form-label">このテストのCVコード</label>
          <input type="text" id="cv-code" class="form-input" placeholder="例: purchase_complete">
        </div>

        <div class="form-group">
          <label class="form-label">対象URL</label>
          <input type="text" id="target-url" class="form-input" placeholder="http://www.sample.com/hoge/hoge.html">
        </div>

        <div class="form-group">
          <label class="form-label">除外URL</label>
          <input type="text" id="exclude-url" class="form-input" placeholder="http://www.sample.com/hoge/form[\d\d][4-8]).html">
        </div>

        <div class="form-group">
          <label class="form-label">期間</label>
          <div class="form-row">
            <input type="date" id="start-date" class="form-input">
            <span class="date-separator">〜</span>
            <input type="date" id="end-date" class="form-input">
          </div>
        </div>
      </div>

      <div class="section">
        <div class="section-title">実行条件</div>
        
        <div class="condition-group">
          <div class="condition-header collapsed" onclick="toggleCondition('device')">
            <span>デバイス</span>
          </div>
          <div class="condition-content" id="condition-device"></div>
        </div>

        <div class="condition-group">
          <div class="condition-header collapsed" onclick="toggleCondition('language')">
            <span>言語</span>
          </div>
          <div class="condition-content" id="condition-language"></div>
        </div>

        <div class="condition-group">
          <div class="condition-header collapsed" onclick="toggleCondition('os')">
            <span>OS</span>
          </div>
          <div class="condition-content" id="condition-os"></div>
        </div>

        <div class="condition-group">
          <div class="condition-header collapsed" onclick="toggleCondition('browser')">
            <span>ブラウザ</span>
          </div>
          <div class="condition-content" id="condition-browser"></div>
        </div>

        <div class="condition-group">
          <div class="condition-header collapsed" onclick="toggleCondition('other')">
            <span>その他</span>
          </div>
          <div class="condition-content" id="condition-other"></div>
        </div>
      </div>

      <div class="creative-section">
        <div class="section-title">クリエイティブ</div>
        <div style="margin-bottom: 12px; font-size: 14px; color: #6b7280;">
          合計実行回数: <span id="total-impressions">1000</span>回
          CV: <span id="total-cv">100</span>
          CVR: <span id="total-cvr">10</span>%
        </div>
        <div id="creatives-list"></div>
        <button class="btn-add" onclick="addCreative()">+</button>
      </div>

      <div style="display: flex; justify-content: center; gap: 16px; margin-top: 32px;">
        <button class="btn-save" onclick="saveABTest()">新規クリエイティブを作成</button>
      </div>
    </main>
  </div>

  <div id="code-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">コードを登録</div>
      
      <div class="modal-section">
        <div class="modal-section-title">CSS</div>
        <textarea id="modal-css" class="code-editor" placeholder=".hoge {&#10;  width: 100px;&#10;}"></textarea>
      </div>

      <div class="modal-section">
        <div class="modal-section-title">JavaScript</div>
        <textarea id="modal-js" class="code-editor" placeholder="const listsContainer = document.getElementById('lists-container');&#10;const addListBtn = document.getElementById('addList');"></textarea>
      </div>

      <div class="modal-footer">
        <button class="btn-modal-save" onclick="saveCode()">登録する</button>
        <button class="btn-modal-cancel" onclick="closeModal()">キャンセル</button>
      </div>
    </div>
  </div>

  <script>
    const API_URL = '/api';
    const params = new URLSearchParams(location.search);
    const abtestId = params.get('id');
    const projectId = params.get('projectId');
    
    let currentABTest = null;
    let conditions = { device: [], language: [], os: [], browser: [], other: [] };
    let creatives = [];
    let currentCreativeIndex = -1;
    let suggestionData = null;
    let activeInputId = null;

    const conditionTypes = [
      { value: 'regex', label: '正規表現に一致' },
      { value: 'startsWith', label: '先頭が一致' },
      { value: 'endsWith', label: '最後が一致' },
      { value: 'contains', label: '含む' },
      { value: 'exact', label: '完全一致' },
      { value: 'oneOf', label: '次のいずれか' },
      { value: 'notRegex', label: '正規表現に一致しない' },
      { value: 'notStartsWith', label: '先頭が一致しない' },
      { value: 'notEndsWith', label: '最後が一致しない' },
      { value: 'notContains', label: '含まない' },
      { value: 'notOneOf', label: '次のいずれでもない' }
    ];

    async function loadSuggestions() {
      try {
        const res = await fetch(`${API_URL}/suggestions`);
        suggestionData = await res.json();
      } catch (err) {
        console.error('Failed to load suggestions:', err);
        suggestionData = { devices: [], browsers: [], oss: [], languages: [] };
      }
    }

    async function loadABTest() {
      await loadSuggestions();
      
      if (!abtestId) {
        // 新規作成モード
        document.getElementById('test-name').value = '';
        initializeConditions();
        addCreative();
        return;
      }

      try {
        const res = await fetch(`${API_URL}/abtests/${abtestId}`);
        currentABTest = await res.json();
        
        document.getElementById('test-name').value = currentABTest.name || '';
        document.getElementById('test-active').checked = currentABTest.active || false;
        document.getElementById('toggle-label').textContent = currentABTest.active ? 'ON' : 'OFF';
        document.getElementById('cv-code').value = currentABTest.cvCode || '';
        document.getElementById('target-url').value = currentABTest.targetUrl || '';
        document.getElementById('exclude-url').value = currentABTest.excludeUrl || '';
        
        if (currentABTest.startDate) {
          document.getElementById('start-date').value = formatDateForInput(currentABTest.startDate);
        }
        if (currentABTest.endDate) {
          document.getElementById('end-date').value = formatDateForInput(currentABTest.endDate);
        }

        conditions = currentABTest.conditions || { device: [], language: [], os: [], browser: [], other: [] };
        creatives = currentABTest.creatives || [];
        
        if (creatives.length === 0) {
          addCreative();
        }

        renderConditions();
        renderCreatives();
      } catch (err) {
        console.error('Failed to load ABTest:', err);
      }
    }

    function formatDateForInput(dateString) {
      const date = new Date(dateString);
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function initializeConditions() {
      ['device', 'language', 'os', 'browser', 'other'].forEach(type => {
        conditions[type] = [];
        addConditionRow(type);
      });
    }

    function renderConditions() {
      ['device', 'language', 'os', 'browser', 'other'].forEach(type => {
        const container = document.getElementById(`condition-${type}`);
        container.innerHTML = '';
        
        if (conditions[type].length === 0) {
          addConditionRow(type);
        } else {
          conditions[type].forEach((_, index) => {
            renderConditionRow(type, index);
          });
        }
        
        // 追加ボタンを追加
        const footer = document.createElement('div');
        footer.className = 'condition-footer';
        footer.innerHTML = `<button class="btn-add-condition" onclick="addConditionRow('${type}')">追加</button>`;
        container.appendChild(footer);
      });
    }

    function renderConditionRow(type, index) {
      const container = document.getElementById(`condition-${type}`);
      const condition = conditions[type][index];
      
      const row = document.createElement('div');
      row.className = 'condition-row';
      
      const inputId = `condition-input-${type}-${index}`;
      const dropdownId = `suggest-dropdown-${type}-${index}`;
      
      if (type === 'other') {
        row.innerHTML = `
          <select data-type="${type}" data-index="${index}" data-field="type">
            <option value="visitCount" ${condition.type === 'visitCount' ? 'selected' : ''}>訪問回数</option>
            <option value="referrer" ${condition.type === 'referrer' ? 'selected' : ''}>リファラーURL</option>
          </select>
          <input type="text" data-type="${type}" data-index="${index}" data-field="value" value="${condition.value || ''}" placeholder="値を入力">
          <select data-type="${type}" data-index="${index}" data-field="condition">
            ${conditionTypes.map(ct => `<option value="${ct.value}" ${condition.condition === ct.value ? 'selected' : ''}>${ct.label}</option>`).join('')}
          </select>
          ${isMultiValueCondition(condition.condition) ? 
            `<textarea data-type="${type}" data-index="${index}" data-field="values" placeholder="改行区切りで入力">${(condition.values || []).join('\n')}</textarea>` :
            ''
          }
          <button class="btn-remove" onclick="removeConditionRow('${type}', ${index})">削除</button>
        `;
      } else {
        row.innerHTML = `
          <div class="suggest-input-wrapper">
            <input type="text" 
                   id="${inputId}"
                   data-type="${type}" 
                   data-index="${index}" 
                   data-field="value" 
                   value="${condition.value || ''}" 
                   placeholder="値を入力"
                   autocomplete="off">
            <div class="suggest-dropdown" id="${dropdownId}"></div>
          </div>
          <select data-type="${type}" data-index="${index}" data-field="condition">
            ${conditionTypes.map(ct => `<option value="${ct.value}" ${condition.condition === ct.value ? 'selected' : ''}>${ct.label}</option>`).join('')}
          </select>
          ${isMultiValueCondition(condition.condition) ? 
            `<textarea data-type="${type}" data-index="${index}" data-field="values" placeholder="改行区切りで入力">${(condition.values || []).join('\n')}</textarea>` :
            ''
          }
          <button class="btn-remove" onclick="removeConditionRow('${type}', ${index})">削除</button>
        `;
      }
      
      // 最後の追加ボタンの前に挿入
      const footer = container.querySelector('.condition-footer');
      if (footer) {
        container.insertBefore(row, footer);
      } else {
        container.appendChild(row);
      }
      
      // サジェスト機能のイベントリスナーを追加
      if (type !== 'other') {
        setupSuggest(inputId, dropdownId, type);
      }
    }

    function setupSuggest(inputId, dropdownId, type) {
      const input = document.getElementById(inputId);
      const dropdown = document.getElementById(dropdownId);
      
      if (!input || !dropdown) return;
      
      let currentIndex = -1;
      
      input.addEventListener('input', (e) => {
        const value = e.target.value.toLowerCase();
        const suggestions = getSuggestions(type, value);
        
        if (suggestions.length === 0 || value === '') {
          dropdown.classList.remove('show');
          return;
        }
        
        dropdown.innerHTML = suggestions
          .map((s, i) => `<div class="suggest-option ${i === 0 ? 'active' : ''}" data-value="${s}">${s}</div>`)
          .join('');
        dropdown.classList.add('show');
        currentIndex = -1;
      });
      
      input.addEventListener('keydown', (e) => {
        const options = dropdown.querySelectorAll('.suggest-option');
        
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          currentIndex = Math.min(currentIndex + 1, options.length - 1);
          updateActiveOption(options, currentIndex);
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          currentIndex = Math.max(currentIndex - 1, -1);
          updateActiveOption(options, currentIndex);
        } else if (e.key === 'Enter') {
          e.preventDefault();
          if (currentIndex >= 0 && options[currentIndex]) {
            input.value = options[currentIndex].dataset.value;
            dropdown.classList.remove('show');
            input.dispatchEvent(new Event('change'));
          }
        } else if (e.key === 'Escape') {
          dropdown.classList.remove('show');
        }
      });
      
      dropdown.addEventListener('click', (e) => {
        const option = e.target.closest('.suggest-option');
        if (option) {
          input.value = option.dataset.value;
          dropdown.classList.remove('show');
          input.dispatchEvent(new Event('change'));
        }
      });
      
      // クリック外を検知して閉じる
      document.addEventListener('click', (e) => {
        if (!input.contains(e.target) && !dropdown.contains(e.target)) {
          dropdown.classList.remove('show');
        }
      });
    }

    function getSuggestions(type, value) {
      if (!suggestionData) return [];
      
      const dataMap = {
        device: suggestionData.devices || [],
        browser: suggestionData.browsers || [],
        os: suggestionData.oss || [],
        language: suggestionData.languages || []
      };
      
      const data = dataMap[type] || [];
      return data.filter(item => item.toLowerCase().includes(value)).slice(0, 10);
    }

    function updateActiveOption(options, index) {
      options.forEach((opt, i) => {
        if (i === index) {
          opt.classList.add('active');
          opt.scrollIntoView({ block: 'nearest' });
        } else {
          opt.classList.remove('active');
        }
      });
    }

    function isMultiValueCondition(conditionType) {
      return conditionType === 'oneOf' || conditionType === 'notOneOf';
    }

    function addConditionRow(type) {
      if (!conditions[type]) conditions[type] = [];
      conditions[type].push({ value: '', condition: 'exact', values: [] });
      renderConditionRow(type, conditions[type].length - 1);
    }

    function removeConditionRow(type, index) {
      conditions[type].splice(index, 1);
      const container = document.getElementById(`condition-${type}`);
      
      // 追加ボタンを除く全ての行を削除
      const rows = container.querySelectorAll('.condition-row');
      rows.forEach(row => row.remove());
      
      // 条件を再描画
      conditions[type].forEach((_, i) => renderConditionRow(type, i));
      
      if (conditions[type].length === 0) {
        addConditionRow(type);
      }
    }

    function toggleCondition(type) {
      const content = document.getElementById(`condition-${type}`);
      const header = content.previousElementSibling;
      content.classList.toggle('show');
      header.classList.toggle('collapsed');
    }

    document.getElementById('test-active').addEventListener('change', (e) => {
      document.getElementById('toggle-label').textContent = e.target.checked ? 'ON' : 'OFF';
    });

    document.addEventListener('change', (e) => {
      if (e.target.dataset.type && e.target.dataset.index !== undefined) {
        const type = e.target.dataset.type;
        const index = parseInt(e.target.dataset.index);
        const field = e.target.dataset.field;
        
        if (field === 'values') {
          conditions[type][index][field] = e.target.value.split('\n').filter(v => v.trim());
        } else {
          conditions[type][index][field] = e.target.value;
        }
        
        // 条件タイプが変更されたら、テキストエリアを再描画
        if (field === 'condition') {
          const container = document.getElementById(`condition-${type}`);
          // 追加ボタンを除く全ての行を削除
          const rows = container.querySelectorAll('.condition-row');
          rows.forEach(row => row.remove());
          // 条件を再描画
          conditions[type].forEach((_, i) => renderConditionRow(type, i));
        }
      }
    });

    function addCreative() {
      creatives.push({
        name: '',
        distribution: 0,
        isOriginal: false,
        css: '',
        javascript: ''
      });
      renderCreatives();
    }

    function removeCreative(index) {
      if (creatives.length <= 1) {
        alert('最低1つのクリエイティブが必要です');
        return;
      }
      creatives.splice(index, 1);
      renderCreatives();
    }

    function renderCreatives() {
      const container = document.getElementById('creatives-list');
      container.innerHTML = '';
      
      creatives.forEach((creative, index) => {
        const row = document.createElement('div');
        row.className = 'creative-row';
        row.innerHTML = `
          <div class="creative-col">
            <label>名称</label>
            <input type="text" value="${creative.name || ''}" data-creative-index="${index}" data-field="name" placeholder="${creative.isOriginal ? 'オリジナル' : '名称'}">
          </div>
          <div class="creative-col">
            <label>配分</label>
            <input type="number" value="${creative.distribution || 0}" data-creative-index="${index}" data-field="distribution" min="0" max="100">%
          </div>
          <div class="creative-col">
            <label>合計実行回数</label>
            <div class="creative-stats">
              <div>350回</div>
              <div>CV: 30</div>
              <div>CVR: 8.571%</div>
            </div>
          </div>
          <div class="creative-col" style="justify-content: flex-end;">
            ${creative.isOriginal ? 
              '<div style="font-size: 12px; color: #6b7280; padding: 8px;">オリジナル</div>' : 
              `<button class="btn-code" onclick="openCodeModal(${index})">コードを登録</button>`
            }
          </div>
          <div class="creative-col" style="justify-content: flex-end;">
            <button class="btn-remove" onclick="removeCreative(${index})">削除</button>
          </div>
          <div class="creative-col" style="justify-content: flex-end;">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" ${creative.isOriginal ? 'checked' : ''} data-creative-index="${index}" data-field="isOriginal">
              <span style="font-size: 13px;">オリジナルを選択</span>
            </label>
          </div>
        `;
        container.appendChild(row);
      });
    }

    document.addEventListener('input', (e) => {
      if (e.target.dataset.creativeIndex !== undefined) {
        const index = parseInt(e.target.dataset.creativeIndex);
        const field = e.target.dataset.field;
        
        if (field === 'isOriginal') {
          creatives[index][field] = e.target.checked;
          renderCreatives();
        } else if (field === 'distribution') {
          creatives[index][field] = parseFloat(e.target.value) || 0;
        } else {
          creatives[index][field] = e.target.value;
        }
      }
    });

    function openCodeModal(index) {
      currentCreativeIndex = index;
      const creative = creatives[index];
      document.getElementById('modal-css').value = creative.css || '';
      document.getElementById('modal-js').value = creative.javascript || '';
      document.getElementById('code-modal').classList.add('show');
    }

    function closeModal() {
      document.getElementById('code-modal').classList.remove('show');
      currentCreativeIndex = -1;
    }

    function saveCode() {
      if (currentCreativeIndex >= 0) {
        creatives[currentCreativeIndex].css = document.getElementById('modal-css').value;
        creatives[currentCreativeIndex].javascript = document.getElementById('modal-js').value;
      }
      closeModal();
    }

    async function saveABTest() {
      const data = {
        projectId: projectId,
        name: document.getElementById('test-name').value,
        active: document.getElementById('test-active').checked,
        cvCode: document.getElementById('cv-code').value,
        targetUrl: document.getElementById('target-url').value,
        excludeUrl: document.getElementById('exclude-url').value,
        startDate: document.getElementById('start-date').value || null,
        endDate: document.getElementById('end-date').value || null,
        conditions: conditions,
        creatives: creatives
      };

      try {
        let res;
        if (abtestId) {
          res = await fetch(`${API_URL}/abtests/${abtestId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
        } else {
          res = await fetch(`${API_URL}/abtests`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
        }

        if (res.ok) {
          alert('保存しました');
          location.href = `abtest-list.html?id=${projectId}`;
        } else {
          alert('保存に失敗しました');
        }
      } catch (err) {
        console.error('Failed to save ABTest:', err);
        alert('保存に失敗しました');
      }
    }

    function goBack() {
      location.href = `abtest-list.html?id=${projectId}`;
    }

    loadABTest();
  </script>
</body>
</html>
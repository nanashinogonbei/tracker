<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ABテスト詳細 - Webトラッカー</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
  <div class="min-h-screen flex">
    <aside class="w-64 bg-white min-h-screen border-r">
      <div class="p-6">
        <div class="mt-4 space-y-1">
          <div class="px-4 py-2 text-sm"><a href="./admin.html">プロジェクト管理</a></div>
          <div class="px-4 py-2 text-sm text-gray-500"><a href="./account_index.html">アカウント管理</a></div>
          <div class="px-4 py-2 text-sm"><a href="#" id="logout-btn" class="text-red-600 hover:text-red-800">ログアウト</a></div>
        </div>
      </div>
    </aside>

    <main class="flex-1 p-8 max-w-6xl">
      <div class="flex justify-between items-center mb-8">
        <div class="flex items-center gap-4">
          <input type="text" id="test-name" placeholder="テスト名を入力" 
                 class="text-2xl font-bold px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          <div class="flex items-center gap-2">
            <span class="text-sm font-medium" id="toggle-label">OFF</span>
            <label class="relative inline-block w-14 h-8 cursor-pointer">
              <input type="checkbox" id="test-active" class="sr-only">
              <span class="absolute inset-0 bg-gray-300 rounded-full transition-colors" id="toggle-bg"></span>
              <span class="absolute left-1 top-1 w-6 h-6 bg-white rounded-full transition-transform" id="toggle-handle"></span>
            </label>
          </div>
        </div>
        <a href="#" onclick="goBack(); return false;" class="text-blue-500 text-sm hover:underline">戻る</a>
      </div>

      <div class="bg-white rounded-lg shadow p-6 mb-6 space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">このテストのCVコード</label>
          <input type="text" id="cv-code" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="例: purchase_complete">
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">対象URL</label>
          <input type="text" id="target-url" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="http://www.sample.com/hoge/hoge.html">
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">除外URL</label>
          <input type="text" id="exclude-url" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="http://www.sample.com/hoge/form[\d\d][4-8]).html">
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">期間</label>
          <div class="flex items-center gap-3">
            <input type="date" id="start-date" class="px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <span class="text-gray-500">〜</span>
            <input type="date" id="end-date" class="px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">セッション期間</label>
          <div class="flex items-center gap-2">
            <input type="time" id="session-duration" value="12:00" class="px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <span class="text-sm text-gray-500">（セッション中は同じクリエイティブを表示）</span>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-lg shadow p-6 mb-6">
        <div class="text-lg font-medium text-gray-900 mb-4">実行条件</div>
        
        <div class="space-y-4">
          <div class="border border-gray-200 rounded-lg">
            <button class="w-full px-4 py-3 text-left font-medium text-gray-700 hover:bg-gray-50 flex justify-between items-center" onclick="toggleCondition('device')">
              <span>デバイス</span>
              <svg class="w-5 h-5 transform transition-transform" id="device-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
            <div class="px-4 pb-4 space-y-2" id="condition-device"></div>
            <div class="px-4 pb-4">
              <button class="text-blue-500 hover:text-blue-600 text-sm" onclick="addConditionRow('device')">+ 条件を追加</button>
            </div>
          </div>

          <div class="border border-gray-200 rounded-lg">
            <button class="w-full px-4 py-3 text-left font-medium text-gray-700 hover:bg-gray-50 flex justify-between items-center" onclick="toggleCondition('language')">
              <span>言語</span>
              <svg class="w-5 h-5 transform transition-transform" id="language-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
            <div class="px-4 pb-4 space-y-2" id="condition-language"></div>
            <div class="px-4 pb-4">
              <button class="text-blue-500 hover:text-blue-600 text-sm" onclick="addConditionRow('language')">+ 条件を追加</button>
            </div>
          </div>

          <div class="border border-gray-200 rounded-lg">
            <button class="w-full px-4 py-3 text-left font-medium text-gray-700 hover:bg-gray-50 flex justify-between items-center" onclick="toggleCondition('os')">
              <span>OS</span>
              <svg class="w-5 h-5 transform transition-transform" id="os-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
            <div class="px-4 pb-4 space-y-2" id="condition-os"></div>
            <div class="px-4 pb-4">
              <button class="text-blue-500 hover:text-blue-600 text-sm" onclick="addConditionRow('os')">+ 条件を追加</button>
            </div>
          </div>

          <div class="border border-gray-200 rounded-lg">
            <button class="w-full px-4 py-3 text-left font-medium text-gray-700 hover:bg-gray-50 flex justify-between items-center" onclick="toggleCondition('browser')">
              <span>ブラウザ</span>
              <svg class="w-5 h-5 transform transition-transform" id="browser-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
            <div class="px-4 pb-4 space-y-2" id="condition-browser"></div>
            <div class="px-4 pb-4">
              <button class="text-blue-500 hover:text-blue-600 text-sm" onclick="addConditionRow('browser')">+ 条件を追加</button>
            </div>
          </div>

          <div class="border border-gray-200 rounded-lg">
            <button class="w-full px-4 py-3 text-left font-medium text-gray-700 hover:bg-gray-50 flex justify-between items-center" onclick="toggleCondition('other')">
              <span>その他</span>
              <svg class="w-5 h-5 transform transition-transform" id="other-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
            <div class="px-4 pb-4" id="condition-other"></div>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-lg shadow p-6 mb-6">
        <div class="text-lg font-medium text-gray-900 mb-3">クリエイティブ</div>
        <div class="text-sm text-gray-600 mb-4">
          合計実行回数: <span id="total-impressions" class="font-semibold">1000</span>回
          CV: <span id="total-cv" class="font-semibold">100</span>
          CVR: <span id="total-cvr" class="font-semibold">10</span>%
        </div>
        <div id="creatives-list" class="space-y-4"></div>
        <button class="mt-4 w-8 h-8 flex items-center justify-center bg-blue-500 text-white rounded-full hover:bg-blue-600 text-xl" onclick="addCreative()">+</button>
      </div>

      <div class="flex justify-center">
        <button class="bg-blue-500 text-white px-8 py-3 rounded-md hover:bg-blue-600 font-medium" onclick="saveABTest()">このテストを保存する</button>
      </div>
    </main>
  </div>

  <div id="code-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
      <div class="p-6 border-b border-gray-200">
        <h3 class="text-xl font-bold text-gray-900">コードを登録</h3>
      </div>
      
      <div class="p-6 space-y-6">
        <div>
          <div class="text-sm font-medium text-gray-700 mb-2">CSS</div>
          <textarea id="modal-css" class="w-full h-48 px-4 py-2 border border-gray-300 rounded-md font-mono text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder=".hoge {&#10;  width: 100px;&#10;}"></textarea>
        </div>

        <div>
          <div class="text-sm font-medium text-gray-700 mb-2">JavaScript</div>
          <textarea id="modal-js" class="w-full h-48 px-4 py-2 border border-gray-300 rounded-md font-mono text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="const listsContainer = document.getElementById('lists-container');&#10;const addListBtn = document.getElementById('addList');"></textarea>
        </div>
      </div>

      <div class="p-6 border-t border-gray-200 flex justify-end gap-3">
        <button class="px-6 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300" onclick="closeModal()">キャンセル</button>
        <button class="px-6 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600" onclick="saveCode()">登録する</button>
      </div>
    </div>
  </div>

  <script>
    const API_URL = '/api';
    const params = new URLSearchParams(location.search);
    const abtestId = params.get('id');
    const projectId = params.get('projectId');

    let currentABTest = null;
    let conditions = { device: [], language: [], os: [], browser: [], other: [] };
    let creatives = [];
    let currentCreativeIndex = -1;
    let suggestionData = null;
    let statsData = null;

    const conditionTypes = [
      { value: 'regex', label: '正規表現に一致' },
      { value: 'startsWith', label: '先頭が一致' },
      { value: 'endsWith', label: '最後が一致' },
      { value: 'contains', label: '含む' },
      { value: 'exact', label: '完全一致' },
      { value: 'oneOf', label: '次のいずれか' },
      { value: 'notRegex', label: '正規表現に一致しない' },
      { value: 'notStartsWith', label: '先頭が一致しない' },
      { value: 'notEndsWith', label: '最後が一致しない' },
      { value: 'notContains', label: '含まない' },
      { value: 'notOneOf', label: '次のいずれでもない' }
    ];

    document.getElementById('test-active').addEventListener('change', (e) => {
      const label = document.getElementById('toggle-label');
      const bg = document.getElementById('toggle-bg');
      const handle = document.getElementById('toggle-handle');
      
      if (e.target.checked) {
        label.textContent = 'ON';
        bg.classList.add('bg-green-500');
        bg.classList.remove('bg-gray-300');
        handle.classList.add('translate-x-6');
      } else {
        label.textContent = 'OFF';
        bg.classList.remove('bg-green-500');
        bg.classList.add('bg-gray-300');
        handle.classList.remove('translate-x-6');
      }
    });

    async function loadABTest() {
      if (!abtestId) {
        document.getElementById('test-name').value = '';
        document.getElementById('session-duration').value = '12:00';
        initializeConditions();
        addCreative();
        return;
      }

      try {
        const res = await fetch(`${API_URL}/abtests/${abtestId}`);
        currentABTest = await res.json();
        
        document.getElementById('test-name').value = currentABTest.name || '';
        
        const activeCheckbox = document.getElementById('test-active');
        activeCheckbox.checked = currentABTest.active || false;
        activeCheckbox.dispatchEvent(new Event('change'));
        
        document.getElementById('cv-code').value = currentABTest.cvCode || '';
        document.getElementById('target-url').value = currentABTest.targetUrl || '';
        document.getElementById('exclude-url').value = currentABTest.excludeUrl || '';
        
        if (currentABTest.startDate) {
          document.getElementById('start-date').value = formatDateForInput(currentABTest.startDate);
        }
        if (currentABTest.endDate) {
          document.getElementById('end-date').value = formatDateForInput(currentABTest.endDate);
        }

        const sessionMinutes = currentABTest.sessionDuration || 720;
        const hours = Math.floor(sessionMinutes / 60);
        const minutes = sessionMinutes % 60;
        document.getElementById('session-duration').value = 
          `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;

        conditions = currentABTest.conditions || { device: [], language: [], os: [], browser: [], other: [] };
        creatives = currentABTest.creatives || [];
        
        if (creatives.length === 0) {
          addCreative();
        }

        renderConditions();
        renderCreatives();
      } catch (err) {
        console.error('Failed to load ABTest:', err);
      }
    }

    async function loadSuggestions() {
      try {
        const res = await fetch(`${API_URL}/abtests/suggestions`);
        suggestionData = await res.json();
        createDataLists();
      } catch (err) {
        console.error('Failed to load suggestions:', err);
        suggestionData = { devices: [], browsers: [], oss: [], languages: [] };
      }
    }

    async function loadABTestStats() {
      if (!abtestId) return;
      
      try {
        const res = await fetch(`${API_URL}/abtests/${abtestId}/stats`);
        statsData = await res.json();
        updateStatsDisplay();
        renderCreatives();
      } catch (err) {
        console.error('Failed to load stats:', err);
      }
    }

    function updateStatsDisplay() {
      if (!statsData) return;
      
      document.getElementById('total-impressions').textContent = 
        statsData.total.totalImpressions.toLocaleString();
      document.getElementById('total-cv').textContent = 
        statsData.total.totalConversions.toLocaleString();
      document.getElementById('total-cvr').textContent = 
        statsData.total.totalCvr.toFixed(2);
    }

    function createDataLists() {
      document.querySelectorAll('datalist[id^="suggestions-"]').forEach(el => el.remove());
      
      const types = [
        { id: 'device', data: suggestionData.devices || [] },
        { id: 'browser', data: suggestionData.browsers || [] },
        { id: 'os', data: suggestionData.oss || [] },
        { id: 'language', data: suggestionData.languages || [] }
      ];
      
      types.forEach(type => {
        const datalist = document.createElement('datalist');
        datalist.id = `suggestions-${type.id}`;
        
        type.data.forEach(value => {
          const option = document.createElement('option');
          option.value = value;
          datalist.appendChild(option);
        });
        
        document.body.appendChild(datalist);
      });
    }

    function formatDateForInput(dateString) {
      const date = new Date(dateString);
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function initializeConditions() {
      ['device', 'language', 'os', 'browser', 'other'].forEach(type => {
        conditions[type] = [];
        addConditionRow(type);
      });
    }

    function renderConditions() {
      ['device', 'language', 'os', 'browser', 'other'].forEach(type => {
        const container = document.getElementById(`condition-${type}`);
        container.innerHTML = '';
        
        if (conditions[type].length === 0) {
          addConditionRow(type);
        } else {
          conditions[type].forEach((_, index) => {
            renderConditionRow(type, index);
          });
        }
      });
    }

    function renderConditionRow(type, index) {
      const container = document.getElementById(`condition-${type}`);
      const condition = conditions[type][index];
      
      const row = document.createElement('div');
      
      if (type === 'other') {
        row.className = 'flex items-center gap-3';
        row.innerHTML = `
          <div class="flex items-center gap-2">
            <span class="text-sm text-gray-700">訪問回数</span>
            <input type="number" class="w-20 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                   data-type="${type}" data-index="${index}" data-field="visitCount" value="${condition.visitCount || '0'}" min="0">
            <span class="text-sm text-gray-700">以上</span>
          </div>
          <div class="flex-1 flex items-center gap-2">
            <span class="text-sm text-gray-700">リファラーURL</span>
            <input type="text" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                   data-type="${type}" data-index="${index}" data-field="referrer" value="${condition.referrer || ''}" 
                   placeholder="例) /^https?:\/\/(www\.)?example\.com\/horse\/123$/i">
          </div>
        `;
      } else {
        row.className = 'flex items-center gap-3';
        row.innerHTML = `
          <input type="text" 
                class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                data-type="${type}" 
                data-index="${index}" 
                data-field="value" 
                value="${condition.value || ''}" 
                placeholder="値を入力"
                list="suggestions-${type}"
                autocomplete="off">
          <select class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                  data-type="${type}" data-index="${index}" data-field="condition">
            ${conditionTypes.map(ct => `<option value="${ct.value}" ${condition.condition === ct.value ? 'selected' : ''}>${ct.label}</option>`).join('')}
          </select>
          ${isMultiValueCondition(condition.condition) ? 
            `<textarea class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                      data-type="${type}" data-index="${index}" data-field="values" 
                      placeholder="改行区切りで入力" rows="3">${(condition.values || []).join('\n')}</textarea>` :
            ''
          }
          <button class="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 text-sm" 
                  onclick="removeConditionRow('${type}', ${index})">削除</button>
        `;
      }
      
      container.appendChild(row);
    }

    function isMultiValueCondition(conditionType) {
      return conditionType === 'oneOf' || conditionType === 'notOneOf';
    }

    function addConditionRow(type) {
      if (!conditions[type]) conditions[type] = [];
      
      if (type === 'other') {
        conditions[type].push({ visitCount: '0', referrer: '' });
      } else {
        conditions[type].push({ value: '', condition: 'exact', values: [] });
      }
      
      renderConditionRow(type, conditions[type].length - 1);
    }

    function removeConditionRow(type, index) {
      conditions[type].splice(index, 1);
      const container = document.getElementById(`condition-${type}`);
      container.innerHTML = '';
      conditions[type].forEach((_, i) => renderConditionRow(type, i));
      
      if (conditions[type].length === 0) {
        addConditionRow(type);
      }
    }

    function toggleCondition(type) {
      const content = document.getElementById(`condition-${type}`);
      const arrow = document.getElementById(`${type}-arrow`);
      
      if (content.classList.contains('hidden')) {
        content.classList.remove('hidden');
        arrow.classList.remove('rotate-180');
      } else {
        content.classList.add('hidden');
        arrow.classList.add('rotate-180');
      }
    }

    document.addEventListener('change', (e) => {
      if (e.target.dataset.type && e.target.dataset.index !== undefined) {
        const type = e.target.dataset.type;
        const index = parseInt(e.target.dataset.index);
        const field = e.target.dataset.field;
        
        if (field === 'values') {
          conditions[type][index][field] = e.target.value.split('\n').filter(v => v.trim());
        } else {
          conditions[type][index][field] = e.target.value;
        }
        
        if (field === 'condition' && type !== 'other') {
          const container = document.getElementById(`condition-${type}`);
          container.innerHTML = '';
          conditions[type].forEach((_, i) => renderConditionRow(type, i));
        }
      }
      
      if (e.target.dataset.creativeIndex !== undefined) {
        const index = parseInt(e.target.dataset.creativeIndex);
        const field = e.target.dataset.field;
        
        if (field === 'isOriginal') {
          creatives[index][field] = e.target.checked;
          renderCreatives();
        } else if (field === 'distribution') {
          creatives[index][field] = parseFloat(e.target.value) || 0;
        } else {
          creatives[index][field] = e.target.value;
        }
      }
    });

    document.addEventListener('input', (e) => {
      if (e.target.dataset.type && e.target.dataset.index !== undefined) {
        const type = e.target.dataset.type;
        const index = parseInt(e.target.dataset.index);
        const field = e.target.dataset.field;
        
        if (field === 'value') {
          conditions[type][index][field] = e.target.value;
        }
      }
      
      if (e.target.dataset.creativeIndex !== undefined) {
        const index = parseInt(e.target.dataset.creativeIndex);
        const field = e.target.dataset.field;
        
        if (field === 'distribution') {
          creatives[index][field] = parseFloat(e.target.value) || 0;
        } else if (field !== 'isOriginal') {
          creatives[index][field] = e.target.value;
        }
      }
    });

    function addCreative() {
      creatives.push({
        name: '',
        distribution: 0,
        isOriginal: false,
        css: '',
        javascript: '',
        imageData: null
      });
      renderCreatives();
    }

    function removeCreative(index) {
      if (creatives.length <= 1) {
        alert('最低1つのクリエイティブが必要です');
        return;
      }
      creatives.splice(index, 1);
      renderCreatives();
    }

    function handleImageUpload(index, file) {
      if (!file || !file.type.startsWith('image/')) {
        alert('画像ファイルを選択してください');
        return;
      }

      const reader = new FileReader();
      reader.onload = (e) => {
        creatives[index].imageData = e.target.result;
        renderCreatives();
      };
      reader.readAsDataURL(file);
    }

    function handleImagePaste(index, e) {
      e.preventDefault();
      const items = e.clipboardData.items;
      
      for (let i = 0; i < items.length; i++) {
        if (items[i].type.startsWith('image/')) {
          const file = items[i].getAsFile();
          handleImageUpload(index, file);
          break;
        }
      }
    }

    function removeImage(index) {
      creatives[index].imageData = null;
      renderCreatives();
    }

    function renderCreatives() {
      const container = document.getElementById('creatives-list');
      container.innerHTML = '';
      
      creatives.forEach((creative, index) => {
        let statsHtml = `
          <div class="text-sm text-gray-600">
            <div>-</div>
            <div>CV: -</div>
            <div>CVR: -</div>
          </div>
        `;
        
        if (statsData && statsData.stats && statsData.stats[index]) {
          const stat = statsData.stats[index];
          statsHtml = `
            <div class="text-sm text-gray-600">
              <div>${stat.impressions.toLocaleString()}回</div>
              <div>CV: ${stat.conversions.toLocaleString()}</div>
              <div>CVR: ${stat.cvr.toFixed(3)}%</div>
            </div>
          `;
        }
        
        const row = document.createElement('div');
        row.className = 'border border-gray-200 rounded-lg p-4';
        row.innerHTML = `
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-start">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">名称</label>
              <input type="text" value="${creative.name || ''}" 
                     data-creative-index="${index}" data-field="name" 
                     placeholder="${creative.isOriginal ? 'オリジナル' : '名称'}"
                     class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">配分</label>
              <div class="flex items-center gap-2">
                <input type="number" value="${creative.distribution || 0}" 
                       data-creative-index="${index}" data-field="distribution" 
                       min="0" max="100"
                       class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <span class="text-gray-700">%</span>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">合計実行回数</label>
              ${statsHtml}
            </div>
            <div class="flex flex-col gap-2">
              ${creative.isOriginal ? 
                '<div class="text-sm text-gray-500 py-2">オリジナル</div>' : 
                `<button class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 text-sm" onclick="openCodeModal(${index})">コードを登録</button>`
              }
              <button class="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 text-sm" onclick="removeCreative(${index})">削除</button>
              <label class="flex items-center gap-2 cursor-pointer">
                <input type="checkbox" ${creative.isOriginal ? 'checked' : ''} 
                       data-creative-index="${index}" data-field="isOriginal"
                       class="w-4 h-4 text-blue-600 rounded">
                <span class="text-sm text-gray-700">オリジナルを選択</span>
              </label>
            </div>
          </div>
        `;
        container.appendChild(row);
      });
    }

    function openCodeModal(index) {
      currentCreativeIndex = index;
      const creative = creatives[index];
      document.getElementById('modal-css').value = creative.css || '';
      document.getElementById('modal-js').value = creative.javascript || '';
      document.getElementById('code-modal').classList.remove('hidden');
      document.getElementById('code-modal').classList.add('flex');
    }

    function closeModal() {
      document.getElementById('code-modal').classList.add('hidden');
      document.getElementById('code-modal').classList.remove('flex');
      currentCreativeIndex = -1;
    }

    function saveCode() {
      if (currentCreativeIndex >= 0) {
        creatives[currentCreativeIndex].css = document.getElementById('modal-css').value;
        creatives[currentCreativeIndex].javascript = document.getElementById('modal-js').value;
      }
      closeModal();
    }

    async function saveABTest() {
      const testName = document.getElementById('test-name').value.trim();
      const cvCode = document.getElementById('cv-code').value.trim();
      
      if (!testName) {
        alert('テスト名を入力してください');
        document.getElementById('test-name').focus();
        return;
      }
      
      if (!cvCode) {
        alert('CVコードを入力してください');
        document.getElementById('cv-code').focus();
        return;
      }
      
      if (creatives.length === 0) {
        alert('最低1つのクリエイティブが必要です');
        return;
      }

      const targetUrl = document.getElementById('target-url').value.trim() || '';
      const excludeUrl = document.getElementById('exclude-url').value.trim() || '';
      const startDate = document.getElementById('start-date').value || null;
      const endDate = document.getElementById('end-date').value || null;
      
      const sessionTime = document.getElementById('session-duration').value;
      const [hours, minutes] = sessionTime.split(':').map(Number);
      const sessionDuration = hours * 60 + minutes;

      const data = {
        projectId: projectId,
        name: testName,
        active: document.getElementById('test-active').checked,
        cvCode: cvCode,
        targetUrl: targetUrl,
        excludeUrl: excludeUrl,
        startDate: startDate,
        endDate: endDate,
        sessionDuration: sessionDuration,
        conditions: conditions,
        creatives: creatives
      };

      try {
        let res;
        if (abtestId) {
          res = await fetch(`${API_URL}/abtests/${abtestId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
        } else {
          res = await fetch(`${API_URL}/abtests`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
        }

        if (res.ok) {
          alert('保存しました');
        } else {
          const error = await res.json();
          alert('保存に失敗しました: ' + (error.error || '不明なエラー'));
        }
      } catch (err) {
        console.error('Failed to save ABTest:', err);
        alert('保存に失敗しました');
      }
    }

    function goBack() {
      location.href = `test_index.html?id=${projectId}`;
    }

    if (sessionStorage.getItem('loggedIn') !== 'true') {
      window.location.href = 'index.html';
    }
    document.getElementById('logout-btn').addEventListener('click', (e) => {
      e.preventDefault();
      if (confirm('ログアウトしますか？')) {
        sessionStorage.clear();
        window.location.href = 'index.html';
      }
    });

    async function init() {
      await loadSuggestions();
      await loadABTest();
      await loadABTestStats();
    }

    init();
  </script>
</body>
</html>
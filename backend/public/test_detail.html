<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ABテスト詳細 - Webトラッカー</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f9fafb; }
    .container { display: flex; min-height: 100vh; }
    .sidebar { width: 16rem; background: white; border-right: 1px solid #e5e7eb; padding: 24px; }
    .sidebar a { display: block; width: 100%; padding: 8px 16px; border: 1px solid #d1d5db; border-radius: 4px; text-align: center; text-decoration: none; color: #374151; font-size: 14px; margin-bottom: 8px; }
    .sidebar-item { padding: 8px 16px; font-size: 14px; color: #6b7280; }
    .main { flex: 1; padding: 32px; max-width: 1200px; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px; }
    .header-left { display: flex; align-items: center; gap: 16px; }
    .header-left input { font-size: 20px; font-weight: bold; border: none; background: transparent; padding: 4px; }
    .toggle-container { display: flex; align-items: center; gap: 12px; }
    .toggle-label { font-size: 14px; font-weight: 500; }
    .toggle-switch { position: relative; width: 56px; height: 32px; cursor: pointer; }
    .toggle-switch input { display: none; }
    .toggle-bg { position: absolute; inset: 0; background: #d1d5db; border-radius: 9999px; transition: background 0.3s; }
    .toggle-switch input:checked + .toggle-bg { background: #22c55e; }
    .toggle-handle { position: absolute; left: 4px; top: 4px; width: 24px; height: 24px; background: white; border-radius: 50%; transition: transform 0.3s; }
    .toggle-switch input:checked ~ .toggle-handle { transform: translateX(24px); }
    .section { background: #fffbeb; border-radius: 8px; padding: 24px; margin-bottom: 24px; }
    .section-title { font-size: 16px; font-weight: 500; margin-bottom: 16px; }
    .form-group { margin-bottom: 16px; }
    .form-label { display: block; font-size: 14px; margin-bottom: 8px; }
    .form-input, .form-textarea { width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 14px; }
    .form-textarea { min-height: 60px; resize: vertical; font-family: monospace; }
    .form-row { display: flex; gap: 16px; align-items: center; }
    .date-separator { padding: 8px; }
    .time-input { width: 120px; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 14px; }
    .condition-group { margin-bottom: 16px; padding: 16px; background: white; border-radius: 8px; }
    .condition-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; cursor: pointer; }
    .condition-header::after { content: '▼'; transition: transform 0.3s; }
    .condition-header.collapsed::after { transform: rotate(-90deg); }
    .condition-content { display: none; }
    .condition-content.show { display: block; }
    .condition-row { display: flex; gap: 12px; margin-bottom: 12px; align-items: center; }
    .condition-row input { flex: 1; }
    .condition-row select { min-width: 180px; }
    .condition-row textarea { flex: 1; min-height: 100px; }
    .btn-add { background: #3b82f6; color: white; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .btn-add-condition { background: #3b82f6; color: white; border: none; border-radius: 50%; width: 32px; height: 32px; font-size: 20px; cursor: pointer; margin-top: 8px; }
    .btn-add-condition:hover { background: #2563eb; }
    .btn-remove { color: #ef4444; background: none; border: none; padding: 8px 16px; cursor: pointer; }
    .creative-section { background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 24px; margin-bottom: 24px; }
    .creative-row { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 1fr 1fr; gap: 16px; margin-bottom: 16px; padding: 16px; background: #f9fafb; border-radius: 8px; align-items: center; }
    .creative-col { display: flex; flex-direction: column; }
    .creative-col label { font-size: 12px; color: #6b7280; margin-bottom: 4px; }
    .creative-col input, .creative-col select { padding: 6px 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 14px; }
    .creative-stats { display: flex; flex-direction: column; }
    .creative-stats div { font-size: 12px; color: #6b7280; }
    .btn-code { background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 13px; white-space: nowrap; }
    .btn-save { background: #3b82f6; color: white; border: none; padding: 12px 32px; border-radius: 4px; cursor: pointer; font-size: 16px; }
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
    .modal.show { display: flex; }
    .modal-content { background: white; border-radius: 8px; padding: 32px; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; }
    .modal-header { font-size: 20px; font-weight: bold; margin-bottom: 24px; }
    .modal-section { margin-bottom: 24px; }
    .modal-section-title { font-size: 16px; font-weight: 500; margin-bottom: 12px; }
    .code-editor { width: 100%; min-height: 200px; padding: 12px; border: 1px solid #d1d5db; border-radius: 4px; font-family: 'Courier New', monospace; font-size: 13px; resize: vertical; }
    .modal-footer { display: flex; justify-content: center; gap: 16px; margin-top: 24px; }
    .btn-modal-save { background: #3b82f6; color: white; border: none; padding: 12px 48px; border-radius: 4px; cursor: pointer; font-size: 16px; }
    .btn-modal-cancel { background: #e5e7eb; border: none; padding: 12px 48px; border-radius: 4px; cursor: pointer; font-size: 16px; }
    
    .other-condition-container { display: flex; gap: 24px; }
    .other-condition-left { display: flex; gap: 12px; align-items: center; }
    .other-condition-right { display: flex; gap: 12px; align-items: center; flex: 1; }
    .other-condition-label { font-size: 14px; color: #374151; white-space: nowrap; }
    .other-condition-number { width: 100px; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 14px; text-align: center; }
    .other-condition-url { flex: 1; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 14px; color: #9ca3af; }
  </style>
</head>
<body>
  <div class="container">
    <aside class="sidebar">
      <div class="sidebar-item"><a href="./admin.html">プロジェクト管理</a></div>
      <div class="sidebar-item">アカウント管理</div>
    </aside>

    <main class="main">
      <div class="header">
        <div class="header-left">
          <input type="text" id="test-name" placeholder="テスト名を入力" value="">
          <div class="toggle-container">
            <span class="toggle-label" id="toggle-label">OFF</span>
            <label class="toggle-switch">
              <input type="checkbox" id="test-active">
              <span class="toggle-bg"></span>
              <span class="toggle-handle"></span>
            </label>
          </div>
        </div>
        <a href="#" onclick="goBack(); return false;" style="color: #3b82f6; font-size: 14px; text-decoration: none;">戻る</a>
      </div>

      <div class="section">
        <div class="form-group">
          <label class="form-label">このテストのCVコード</label>
          <input type="text" id="cv-code" class="form-input" placeholder="例: purchase_complete">
        </div>

        <div class="form-group">
          <label class="form-label">対象URL</label>
          <input type="text" id="target-url" class="form-input" placeholder="http://www.sample.com/hoge/hoge.html">
        </div>

        <div class="form-group">
          <label class="form-label">除外URL</label>
          <input type="text" id="exclude-url" class="form-input" placeholder="http://www.sample.com/hoge/form[\d\d][4-8]).html">
        </div>

        <div class="form-group">
          <label class="form-label">期間</label>
          <div class="form-row">
            <input type="date" id="start-date" class="form-input">
            <span class="date-separator">〜</span>
            <input type="date" id="end-date" class="form-input">
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">セッション期間</label>
          <input type="time" id="session-duration" class="time-input" value="12:00">
          <span style="margin-left: 8px; font-size: 14px; color: #6b7280;">（セッション中は同じクリエイティブを表示）</span>
        </div>
      </div>

      <div class="section">
        <div class="section-title">実行条件</div>
        
        <div class="condition-group">
          <div class="condition-header" onclick="toggleCondition('device')">
            <span>デバイス</span>
          </div>
          <div class="condition-content show" id="condition-device"></div>
          <button class="btn-add-condition" onclick="addConditionRow('device')">+</button>
        </div>

        <div class="condition-group">
          <div class="condition-header" onclick="toggleCondition('language')">
            <span>言語</span>
          </div>
          <div class="condition-content show" id="condition-language"></div>
          <button class="btn-add-condition" onclick="addConditionRow('language')">+</button>
        </div>

        <div class="condition-group">
          <div class="condition-header" onclick="toggleCondition('os')">
            <span>OS</span>
          </div>
          <div class="condition-content show" id="condition-os"></div>
          <button class="btn-add-condition" onclick="addConditionRow('os')">+</button>
        </div>

        <div class="condition-group">
          <div class="condition-header" onclick="toggleCondition('browser')">
            <span>ブラウザ</span>
          </div>
          <div class="condition-content show" id="condition-browser"></div>
          <button class="btn-add-condition" onclick="addConditionRow('browser')">+</button>
        </div>

        <div class="condition-group">
          <div class="condition-header" onclick="toggleCondition('other')">
            <span>その他</span>
          </div>
          <div class="condition-content show" id="condition-other"></div>
        </div>
      </div>

      <div class="creative-section">
        <div class="section-title">クリエイティブ</div>
        <div style="margin-bottom: 12px; font-size: 14px; color: #6b7280;">
          合計実行回数: <span id="total-impressions">1000</span>回
          CV: <span id="total-cv">100</span>
          CVR: <span id="total-cvr">10</span>%
        </div>
        <div id="creatives-list"></div>
        <button class="btn-add" onclick="addCreative()">+</button>
      </div>

      <div style="display: flex; justify-content: center; gap: 16px; margin-top: 32px;">
        <button class="btn-save" onclick="saveABTest()">このテストを保存する</button>
      </div>
    </main>
  </div>

  <div id="code-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">コードを登録</div>
      
      <div class="modal-section">
        <div class="modal-section-title">CSS</div>
        <textarea id="modal-css" class="code-editor" placeholder=".hoge {&#10;  width: 100px;&#10;}"></textarea>
      </div>

      <div class="modal-section">
        <div class="modal-section-title">JavaScript</div>
        <textarea id="modal-js" class="code-editor" placeholder="const listsContainer = document.getElementById('lists-container');&#10;const addListBtn = document.getElementById('addList');"></textarea>
      </div>

      <div class="modal-footer">
        <button class="btn-modal-save" onclick="saveCode()">登録する</button>
        <button class="btn-modal-cancel" onclick="closeModal()">キャンセル</button>
      </div>
    </div>
  </div>

  <script>
    const API_URL = '/api';
    const params = new URLSearchParams(location.search);
    const abtestId = params.get('id');
    const projectId = params.get('projectId');
    
    let currentABTest = null;
    let conditions = { device: [], language: [], os: [], browser: [], other: [] };
    let creatives = [];
    let currentCreativeIndex = -1;
    let suggestionData = null;

    const conditionTypes = [
      { value: 'regex', label: '正規表現に一致' },
      { value: 'startsWith', label: '先頭が一致' },
      { value: 'endsWith', label: '最後が一致' },
      { value: 'contains', label: '含む' },
      { value: 'exact', label: '完全一致' },
      { value: 'oneOf', label: '次のいずれか' },
      { value: 'notRegex', label: '正規表現に一致しない' },
      { value: 'notStartsWith', label: '先頭が一致しない' },
      { value: 'notEndsWith', label: '最後が一致しない' },
      { value: 'notContains', label: '含まない' },
      { value: 'notOneOf', label: '次のいずれでもない' }
    ];

    async function loadABTest() {
      if (!abtestId) {
        document.getElementById('test-name').value = '';
        document.getElementById('session-duration').value = '12:00';
        initializeConditions();
        addCreative();
        return;
      }

      try {
        const res = await fetch(`${API_URL}/abtests/${abtestId}`);
        currentABTest = await res.json();
        
        document.getElementById('test-name').value = currentABTest.name || '';
        document.getElementById('test-active').checked = currentABTest.active || false;
        document.getElementById('toggle-label').textContent = currentABTest.active ? 'ON' : 'OFF';
        document.getElementById('cv-code').value = currentABTest.cvCode || '';
        document.getElementById('target-url').value = currentABTest.targetUrl || '';
        document.getElementById('exclude-url').value = currentABTest.excludeUrl || '';
        
        if (currentABTest.startDate) {
          document.getElementById('start-date').value = formatDateForInput(currentABTest.startDate);
        }
        if (currentABTest.endDate) {
          document.getElementById('end-date').value = formatDateForInput(currentABTest.endDate);
        }

        // セッション期間の設定
        const sessionMinutes = currentABTest.sessionDuration || 720;
        const hours = Math.floor(sessionMinutes / 60);
        const minutes = sessionMinutes % 60;
        document.getElementById('session-duration').value = 
          `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;

        conditions = currentABTest.conditions || { device: [], language: [], os: [], browser: [], other: [] };
        creatives = currentABTest.creatives || [];
        
        if (creatives.length === 0) {
          addCreative();
        }

        renderConditions();
        renderCreatives();
      } catch (err) {
        console.error('Failed to load ABTest:', err);
      }
    }

    async function loadSuggestions() {
      try {
        const res = await fetch(`${API_URL}/suggestions`);
        suggestionData = await res.json();
        createDataLists();
      } catch (err) {
        console.error('Failed to load suggestions:', err);
        suggestionData = { devices: [], browsers: [], oss: [], languages: [] };
      }
    }

    function createDataLists() {
      // 既存のdatalistを削除
      document.querySelectorAll('datalist[id^="suggestions-"]').forEach(el => el.remove());
      
      // 各タイプのdatalistを作成
      const types = [
        { id: 'device', data: suggestionData.devices || [] },
        { id: 'browser', data: suggestionData.browsers || [] },
        { id: 'os', data: suggestionData.oss || [] },
        { id: 'language', data: suggestionData.languages || [] }
      ];
      
      types.forEach(type => {
        const datalist = document.createElement('datalist');
        datalist.id = `suggestions-${type.id}`;
        
        type.data.forEach(value => {
          const option = document.createElement('option');
          option.value = value;
          datalist.appendChild(option);
        });
        
        document.body.appendChild(datalist);
      });
    }

    function formatDateForInput(dateString) {
      const date = new Date(dateString);
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function initializeConditions() {
      ['device', 'language', 'os', 'browser', 'other'].forEach(type => {
        conditions[type] = [];
        addConditionRow(type);
      });
    }

    function renderConditions() {
      ['device', 'language', 'os', 'browser', 'other'].forEach(type => {
        const container = document.getElementById(`condition-${type}`);
        container.innerHTML = '';
        
        if (conditions[type].length === 0) {
          addConditionRow(type);
        } else {
          conditions[type].forEach((_, index) => {
            renderConditionRow(type, index);
          });
        }
      });
    }

    function renderConditionRow(type, index) {
      const container = document.getElementById(`condition-${type}`);
      const condition = conditions[type][index];
      
      const row = document.createElement('div');
      
      if (type === 'other') {
        row.className = 'other-condition-container';
        row.innerHTML = `
          <div class="other-condition-left">
            <span class="other-condition-label">訪問回数</span>
            <input type="number" class="other-condition-number" data-type="${type}" data-index="${index}" data-field="visitCount" value="${condition.visitCount || '0'}" min="0">
            <span class="other-condition-label">以上</span>
          </div>
          <div class="other-condition-right">
            <span class="other-condition-label">リファラーURL</span>
            <input type="text" class="other-condition-url" data-type="${type}" data-index="${index}" data-field="referrer" value="${condition.referrer || ''}" placeholder="例) /^https?:\/\/(www\.)?example\.com\/horse\/123$/i">
          </div>
        `;
      } else {
        row.className = 'condition-row';
        row.innerHTML = `
          <input type="text" 
                 data-type="${type}" 
                 data-index="${index}" 
                 data-field="value" 
                 value="${condition.value || ''}" 
                 placeholder="値を入力"
                 list="suggestions-${type}"
                 autocomplete="off">
          <select data-type="${type}" data-index="${index}" data-field="condition">
            ${conditionTypes.map(ct => `<option value="${ct.value}" ${condition.condition === ct.value ? 'selected' : ''}>${ct.label}</option>`).join('')}
          </select>
          ${isMultiValueCondition(condition.condition) ? 
            `<textarea data-type="${type}" data-index="${index}" data-field="values" placeholder="改行区切りで入力">${(condition.values || []).join('\n')}</textarea>` :
            ''
          }
          <button class="btn-remove" onclick="removeConditionRow('${type}', ${index})">削除</button>
        `;
      }
      
      container.appendChild(row);
    }

    function isMultiValueCondition(conditionType) {
      return conditionType === 'oneOf' || conditionType === 'notOneOf';
    }

    function addConditionRow(type) {
      if (!conditions[type]) conditions[type] = [];
      
      if (type === 'other') {
        conditions[type].push({ visitCount: '0', referrer: '' });
      } else {
        conditions[type].push({ value: '', condition: 'exact', values: [] });
      }
      
      renderConditionRow(type, conditions[type].length - 1);
    }

    function removeConditionRow(type, index) {
      conditions[type].splice(index, 1);
      const container = document.getElementById(`condition-${type}`);
      container.innerHTML = '';
      conditions[type].forEach((_, i) => renderConditionRow(type, i));
      
      if (conditions[type].length === 0) {
        addConditionRow(type);
      }
    }

    function toggleCondition(type) {
      const content = document.getElementById(`condition-${type}`);
      const header = content.previousElementSibling;
      content.classList.toggle('show');
      header.classList.toggle('collapsed');
    }

    document.getElementById('test-active').addEventListener('change', (e) => {
      document.getElementById('toggle-label').textContent = e.target.checked ? 'ON' : 'OFF';
    });

    document.addEventListener('change', (e) => {
      if (e.target.dataset.type && e.target.dataset.index !== undefined) {
        const type = e.target.dataset.type;
        const index = parseInt(e.target.dataset.index);
        const field = e.target.dataset.field;
        
        if (field === 'values') {
          conditions[type][index][field] = e.target.value.split('\n').filter(v => v.trim());
        } else {
          conditions[type][index][field] = e.target.value;
        }
        
        if (field === 'condition' && type !== 'other') {
          const container = document.getElementById(`condition-${type}`);
          container.innerHTML = '';
          conditions[type].forEach((_, i) => renderConditionRow(type, i));
        }
      }
    });

    document.addEventListener('input', (e) => {
      if (e.target.dataset.type && e.target.dataset.index !== undefined) {
        const type = e.target.dataset.type;
        const index = parseInt(e.target.dataset.index);
        const field = e.target.dataset.field;
        
        if (field === 'value') {
          conditions[type][index][field] = e.target.value;
        }
      }
      
      if (e.target.dataset.creativeIndex !== undefined) {
        const index = parseInt(e.target.dataset.creativeIndex);
        const field = e.target.dataset.field;
        
        if (field === 'isOriginal') {
          creatives[index][field] = e.target.checked;
          renderCreatives();
        } else if (field === 'distribution') {
          creatives[index][field] = parseFloat(e.target.value) || 0;
        } else {
          creatives[index][field] = e.target.value;
        }
      }
    });

    function addCreative() {
      creatives.push({
        name: '',
        distribution: 0,
        isOriginal: false,
        css: '',
        javascript: ''
      });
      renderCreatives();
    }

    function removeCreative(index) {
      if (creatives.length <= 1) {
        alert('最低1つのクリエイティブが必要です');
        return;
      }
      creatives.splice(index, 1);
      renderCreatives();
    }

    function renderCreatives() {
      const container = document.getElementById('creatives-list');
      container.innerHTML = '';
      
      creatives.forEach((creative, index) => {
        const row = document.createElement('div');
        row.className = 'creative-row';
        row.innerHTML = `
          <div class="creative-col">
            <label>名称</label>
            <input type="text" value="${creative.name || ''}" data-creative-index="${index}" data-field="name" placeholder="${creative.isOriginal ? 'オリジナル' : '名称'}">
          </div>
          <div class="creative-col">
            <label>配分</label>
            <input type="number" value="${creative.distribution || 0}" data-creative-index="${index}" data-field="distribution" min="0" max="100">%
          </div>
          <div class="creative-col">
            <label>合計実行回数</label>
            <div class="creative-stats">
              <div>350回</div>
              <div>CV: 30</div>
              <div>CVR: 8.571%</div>
            </div>
          </div>
          <div class="creative-col" style="justify-content: flex-end;">
            ${creative.isOriginal ? 
              '<div style="font-size: 12px; color: #6b7280; padding: 8px;">オリジナル</div>' : 
              `<button class="btn-code" onclick="openCodeModal(${index})">コードを登録</button>`
            }
          </div>
          <div class="creative-col" style="justify-content: flex-end;">
            <button class="btn-remove" onclick="removeCreative(${index})">削除</button>
          </div>
          <div class="creative-col" style="justify-content: flex-end;">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" ${creative.isOriginal ? 'checked' : ''} data-creative-index="${index}" data-field="isOriginal">
              <span style="font-size: 13px;">オリジナルを選択</span>
            </label>
          </div>
        `;
        container.appendChild(row);
      });
    }

    function openCodeModal(index) {
      currentCreativeIndex = index;
      const creative = creatives[index];
      document.getElementById('modal-css').value = creative.css || '';
      document.getElementById('modal-js').value = creative.javascript || '';
      document.getElementById('code-modal').classList.add('show');
    }

    function closeModal() {
      document.getElementById('code-modal').classList.remove('show');
      currentCreativeIndex = -1;
    }

    function saveCode() {
      if (currentCreativeIndex >= 0) {
        creatives[currentCreativeIndex].css = document.getElementById('modal-css').value;
        creatives[currentCreativeIndex].javascript = document.getElementById('modal-js').value;
      }
      closeModal();
    }

    async function saveABTest() {
      const testName = document.getElementById('test-name').value.trim();
      const cvCode = document.getElementById('cv-code').value.trim();
      
      if (!testName) {
        alert('テスト名を入力してください');
        document.getElementById('test-name').focus();
        return;
      }
      
      if (!cvCode) {
        alert('CVコードを入力してください');
        document.getElementById('cv-code').focus();
        return;
      }
      
      if (creatives.length === 0) {
        alert('最低1つのクリエイティブが必要です');
        return;
      }

      const targetUrl = document.getElementById('target-url').value.trim() || '';
      const excludeUrl = document.getElementById('exclude-url').value.trim() || '';
      const startDate = document.getElementById('start-date').value || null;
      const endDate = document.getElementById('end-date').value || null;
      
      // セッション期間を分に変換
      const sessionTime = document.getElementById('session-duration').value;
      const [hours, minutes] = sessionTime.split(':').map(Number);
      const sessionDuration = hours * 60 + minutes;

      const data = {
        projectId: projectId,
        name: testName,
        active: document.getElementById('test-active').checked,
        cvCode: cvCode,
        targetUrl: targetUrl,
        excludeUrl: excludeUrl,
        startDate: startDate,
        endDate: endDate,
        sessionDuration: sessionDuration,
        conditions: conditions,
        creatives: creatives
      };

      try {
        let res;
        if (abtestId) {
          res = await fetch(`${API_URL}/abtests/${abtestId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
        } else {
          res = await fetch(`${API_URL}/abtests`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
        }

        if (res.ok) {
          alert('保存しました');
          location.href = `test_index.html?id=${projectId}`;
        } else {
          const error = await res.json();
          alert('保存に失敗しました: ' + (error.error || '不明なエラー'));
        }
      } catch (err) {
        console.error('Failed to save ABTest:', err);
        alert('保存に失敗しました');
      }
    }

    function goBack() {
      location.href = `test_index.html?id=${projectId}`;
    }

    let statsData = null;
    async function loadABTestStats() {
      if (!abtestId) return;
      
      try {
        const res = await fetch(`${API_URL}/abtests/${abtestId}/stats`);
        statsData = await res.json();
        updateStatsDisplay();
      } catch (err) {
        console.error('Failed to load stats:', err);
      }
    }

    function updateStatsDisplay() {
      if (!statsData) return;
      
      // 合計統計の更新
      document.getElementById('total-impressions').textContent = 
        statsData.total.totalImpressions.toLocaleString();
      document.getElementById('total-cv').textContent = 
        statsData.total.totalConversions.toLocaleString();
      document.getElementById('total-cvr').textContent = 
        statsData.total.totalCvr.toFixed(2);
    }

    function renderCreatives() {
      const container = document.getElementById('creatives-list');
      container.innerHTML = '';
      
      creatives.forEach((creative, index) => {
        // 統計情報の取得
        let statsHtml = `
          <div class="creative-stats">
            <div>-</div>
            <div>CV: -</div>
            <div>CVR: -</div>
          </div>
        `;
        
        if (statsData && statsData.stats && statsData.stats[index]) {
          const stat = statsData.stats[index];
          statsHtml = `
            <div class="creative-stats">
              <div>${stat.impressions.toLocaleString()}回</div>
              <div>CV: ${stat.conversions.toLocaleString()}</div>
              <div>CVR: ${stat.cvr.toFixed(3)}%</div>
            </div>
          `;
        }
        
        const row = document.createElement('div');
        row.className = 'creative-row';
        row.innerHTML = `
          <div class="creative-col">
            <label>名称</label>
            <input type="text" value="${creative.name || ''}" data-creative-index="${index}" data-field="name" placeholder="${creative.isOriginal ? 'オリジナル' : '名称'}">
          </div>
          <div class="creative-col">
            <label>配分</label>
            <input type="number" value="${creative.distribution || 0}" data-creative-index="${index}" data-field="distribution" min="0" max="100">%
          </div>
          <div class="creative-col">
            <label>合計実行回数</label>
            ${statsHtml}
          </div>
          <div class="creative-col" style="justify-content: flex-end;">
            ${creative.isOriginal ? 
              '<div style="font-size: 12px; color: #6b7280; padding: 8px;">オリジナル</div>' : 
              `<button class="btn-code" onclick="openCodeModal(${index})">コードを登録</button>`
            }
          </div>
          <div class="creative-col" style="justify-content: flex-end;">
            <button class="btn-remove" onclick="removeCreative(${index})">削除</button>
          </div>
          <div class="creative-col" style="justify-content: flex-end;">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" ${creative.isOriginal ? 'checked' : ''} data-creative-index="${index}" data-field="isOriginal">
              <span style="font-size: 13px;">オリジナルを選択</span>
            </label>
          </div>
        `;
        container.appendChild(row);
      });
    }

    // init関数を修正
    async function init() {
      await loadSuggestions();
      await loadABTest();
      await loadABTestStats(); // 統計情報の読み込みを追加
    }

    init();
  </script>
</body>
</html>
